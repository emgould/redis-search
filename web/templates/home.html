{% extends "base.html" %} {% block title %}Media Search - Find Movies & TV
Shows{% endblock %} {% block body %}
<div class="min-h-full flex flex-col">
  <!-- Header -->
  <header class="border-b border-surface-800 bg-surface-900/50 backdrop-blur-sm sticky top-0 z-50">
    <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2">
        <div class="w-8 h-8 bg-gradient-to-br from-brand-500 to-brand-600 rounded-lg flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z" />
          </svg>
        </div>
        <span class="font-semibold text-lg">MediaSearch</span>
      </a>
      <nav class="flex items-center gap-4 text-sm text-surface-400">
        <a href="/management" class="hover:text-white transition-colors">Management</a>
        <a href="/etl" class="hover:text-white transition-colors">ETL</a>
        <a href="/admin/index_info" class="hover:text-white transition-colors">Index Info</a>
        <a href="http://localhost:8001" target="_blank"
          class="flex items-center gap-1 hover:text-white transition-colors">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z" />
          </svg>
          RedisInsight
        </a>
      </nav>
    </div>
  </header>

  <!-- Redis Connection Indicator -->
  <div class="px-4 py-1.5 flex items-center justify-end gap-3">
    <button id="api-base-toggle"
      class="px-3 py-1 rounded-full border border-surface-700 text-sm text-surface-300 hover:border-surface-500 transition-colors">
      Connected to Public Cloud Run (click to switch)
    </button>
    <div class="flex items-center gap-1.5 text-xs text-surface-500">
      <span
        class="w-1.5 h-1.5 rounded-full {% if current_env == 'local' %}bg-green-500{% else %}bg-blue-500{% endif %}"></span>
      <span id="redis-env-label" data-env="{{ current_env | capitalize }}"></span>
    </div>
  </div>

  <!-- Main Content -->
  <main class="flex-1 flex flex-col items-center justify-start pt-16 md:pt-24 px-4">
    <!-- Hero Section -->
    <div class="text-center mb-8">
      <h1
        class="text-4xl md:text-5xl font-bold mb-3 bg-gradient-to-r from-white via-surface-200 to-surface-400 bg-clip-text text-transparent">
        Find Your Next Watch
      </h1>
      <p class="text-surface-400 text-lg">
        Search all media powered by MediaCircle
      </p>
    </div>

    <div class="w-full max-w-2xl">
      <!-- Search Container -->
      <div class="relative" id="search-container">
        <!-- Search Input with Stream Toggle -->
        <div class="flex items-center gap-3">
          <div class="relative flex-1">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <svg class="w-5 h-5 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
              </svg>
            </div>
            <input type="text" id="search-input" placeholder="Search for movies, TV shows..." autocomplete="off"
              class="w-full pl-12 pr-4 py-4 bg-surface-800 border border-surface-700 rounded-2xl text-white placeholder-surface-500 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-transparent text-lg transition-all" />
            <div id="loading-spinner" class="absolute inset-y-0 right-0 pr-4 flex items-center hidden">
              <svg class="animate-spin h-5 w-5 text-brand-500" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
              </svg>
            </div>
          </div>
          <!-- Stream Toggle -->
          <div class="flex items-center gap-2 px-3 py-2 bg-surface-800 border border-surface-700 rounded-xl">
            <label for="stream-toggle" class="text-xs text-surface-400 cursor-pointer select-none whitespace-nowrap">
              Stream
            </label>
            <button type="button" id="stream-toggle" role="switch" aria-checked="false"
              class="relative inline-flex h-5 w-9 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-brand-500 focus:ring-offset-2 focus:ring-offset-surface-900 bg-surface-600"
              onclick="toggleStreamMode()">
              <span class="sr-only">Enable streaming</span>
              <span id="stream-toggle-dot" aria-hidden="true"
                class="pointer-events-none inline-block h-4 w-4 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-0"></span>
            </button>
          </div>
        </div>

        <!-- Filter Buttons -->
        <div id="filter-buttons" class="mt-3 flex flex-wrap gap-2 justify-center">
          <button data-filter="tv" onclick="toggleFilter('tv')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-blue-500 hover:text-blue-400">
            üì∫ TV
          </button>
          <button data-filter="movie" onclick="toggleFilter('movie')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-purple-500 hover:text-purple-400">
            üé¨ Movies
          </button>
          <button data-filter="person" onclick="toggleFilter('person')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-green-500 hover:text-green-400">
            üë§ People
          </button>
          <button data-filter="artist" onclick="toggleFilter('artist')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-lime-500 hover:text-lime-400">
            üé§ Artists
          </button>
          <button data-filter="album" onclick="toggleFilter('album')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-violet-500 hover:text-violet-400">
            üíø Albums
          </button>
          <button data-filter="video" onclick="toggleFilter('video')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-red-500 hover:text-red-400">
            ‚ñ∂Ô∏è Videos
          </button>
          <button data-filter="podcast" onclick="toggleFilter('podcast')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-pink-500 hover:text-pink-400">
            üéôÔ∏è Podcasts
          </button>
          <button data-filter="book" onclick="toggleFilter('book')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-emerald-500 hover:text-emerald-400">
            üìö Books
          </button>
          <button data-filter="author" onclick="toggleFilter('author')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-amber-500 hover:text-amber-400">
            ‚úçÔ∏è Authors
          </button>
          <button data-filter="news" onclick="toggleFilter('news')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-cyan-500 hover:text-cyan-400">
            üì∞ News
          </button>
          <button data-filter="ratings" onclick="toggleFilter('ratings')"
            class="filter-btn px-3 py-1.5 rounded-full text-sm border transition-all duration-200
                   border-surface-600 text-surface-400 hover:border-rose-500 hover:text-rose-400">
            üçÖ Ratings
          </button>
        </div>
        <p id="filter-hint" class="text-center text-xs text-surface-500 mt-2">
          Press <kbd class="px-1.5 py-0.5 bg-surface-700 rounded text-surface-300">Enter</kbd> to search all sources, or select filters above
        </p>

        <!-- Results Dropdown -->
        <div id="results-container" class="absolute top-full left-0 right-0 mt-2 hidden" style="top: calc(100% + 80px);">
          <div
            class="bg-surface-900 border border-surface-700 rounded-2xl shadow-2xl shadow-black/50 overflow-hidden search-results-enter">
            <div id="results-list" class="max-h-[70vh] overflow-y-auto">
              <!-- Results will be inserted here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Quick hints -->
    <div class="mt-6 flex flex-wrap gap-2 justify-center">
      <span class="text-surface-500 text-sm">Try:</span>
      <button onclick="searchFor('The Office')"
        class="px-3 py-1 bg-surface-800 hover:bg-surface-700 rounded-full text-sm text-surface-300 transition-colors">
        The Office
      </button>
      <button onclick="searchFor('Breaking')"
        class="px-3 py-1 bg-surface-800 hover:bg-surface-700 rounded-full text-sm text-surface-300 transition-colors">
        Breaking
      </button>
      <button onclick="searchFor('Star')"
        class="px-3 py-1 bg-surface-800 hover:bg-surface-700 rounded-full text-sm text-surface-300 transition-colors">
        Star
      </button>
    </div>
  </main>

  <!-- Footer -->
  <footer class="py-6 text-center text-surface-600 text-sm">
    <p>Powered by MediaCircle ‚Ä¢ Built for speed</p>
  </footer>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="fixed inset-0 z-50 hidden">
  <!-- Backdrop -->
  <div id="modal-backdrop" class="absolute inset-0 bg-black/80 backdrop-blur-sm"></div>

  <!-- Modal Content -->
  <div class="absolute inset-4 md:inset-8 lg:inset-16 flex items-start justify-center overflow-y-auto">
    <div id="modal-content"
      class="relative bg-surface-900 rounded-2xl border border-surface-700 shadow-2xl w-full max-w-4xl my-8">
      <!-- Close Button -->
      <button id="modal-close"
        class="absolute top-4 right-4 z-10 p-2 rounded-full bg-surface-800 hover:bg-surface-700 transition-colors">
        <svg class="w-6 h-6 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <!-- Loading State -->
      <div id="modal-loading" class="p-16 text-center">
        <svg class="animate-spin h-10 w-10 mx-auto text-brand-500" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor"
            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
          </path>
        </svg>
        <p class="mt-4 text-surface-400">Loading...</p>
      </div>

      <!-- Content Container -->
      <div id="modal-body" class="hidden"></div>
    </div>
  </div>
</div>

<!-- External Link Iframe Modal -->
<div id="iframe-modal" class="fixed inset-0 z-[60] hidden">
  <!-- Backdrop -->
  <div id="iframe-modal-backdrop" class="absolute inset-0 bg-black/90 backdrop-blur-sm"></div>

  <!-- Modal Content -->
  <div class="absolute inset-4 md:inset-8 flex flex-col">
    <!-- Header -->
    <div class="flex items-center justify-between mb-4">
      <h3 id="iframe-modal-title" class="text-lg font-semibold text-white"></h3>
      <div class="flex items-center gap-2">
        <a id="iframe-open-external" href="#" target="_blank" rel="noopener noreferrer"
          class="px-3 py-1.5 bg-surface-700 hover:bg-surface-600 rounded-lg text-sm text-white transition-colors flex items-center gap-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
          </svg>
          Open in New Tab
        </a>
        <button id="iframe-modal-close" class="p-2 rounded-full bg-surface-800 hover:bg-surface-700 transition-colors">
          <svg class="w-5 h-5 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Iframe Container -->
    <div class="flex-1 bg-white rounded-xl overflow-hidden shadow-2xl">
      <iframe id="iframe-content" class="w-full h-full border-0" src="about:blank"></iframe>
    </div>
  </div>
</div>

<script>
  const searchInput = document.getElementById("search-input");
  const resultsContainer = document.getElementById("results-container");
  const resultsList = document.getElementById("results-list");
  const loadingSpinner = document.getElementById("loading-spinner");
  const apiBaseToggle = document.getElementById("api-base-toggle");
  const redisEnvLabel = document.getElementById("redis-env-label");

  const API_BASES = {
    local: "",
    public: "https://redis-search-api-dev-wabm4u2pza-uc.a.run.app",
  };
  let currentApiBaseKey = "local";

  function connectionLabel() {
    return currentApiBaseKey === "public" ? "Public Cloud Run" : "Local API";
  }

  function updateApiBaseControls() {
    apiBaseToggle.textContent = `Connected to ${connectionLabel()} (click to switch)`;
  }

  if (redisEnvLabel) {
    const envLabel = redisEnvLabel.dataset.env || "";
    redisEnvLabel.textContent = `${envLabel} Redis`;
  }

  function getCurrentApiBase() {
    return API_BASES[currentApiBaseKey];
  }

  function getApiUrl(path) {
    const base = getCurrentApiBase();
    return `${base}${path}`;
  }

  apiBaseToggle.addEventListener("click", () => {
    currentApiBaseKey = currentApiBaseKey === "public" ? "local" : "public";
    updateApiBaseControls();
  });

  updateApiBaseControls();

  let debounceTimer;
  let currentQuery = "";
  let abortController = null; // For canceling in-flight requests
  let eventSource = null; // For streaming mode
  let streamingEnabled = false; // Toggle state
  
  // Filter state - tracks which source filters are active
  const activeFilters = new Set();
  
  // Filter color mappings for visual feedback
  const filterColors = {
    tv: { border: 'border-blue-500', text: 'text-blue-400', bg: 'bg-blue-500/20' },
    movie: { border: 'border-purple-500', text: 'text-purple-400', bg: 'bg-purple-500/20' },
    person: { border: 'border-green-500', text: 'text-green-400', bg: 'bg-green-500/20' },
    artist: { border: 'border-lime-500', text: 'text-lime-400', bg: 'bg-lime-500/20' },
    album: { border: 'border-violet-500', text: 'text-violet-400', bg: 'bg-violet-500/20' },
    video: { border: 'border-red-500', text: 'text-red-400', bg: 'bg-red-500/20' },
    podcast: { border: 'border-pink-500', text: 'text-pink-400', bg: 'bg-pink-500/20' },
    book: { border: 'border-emerald-500', text: 'text-emerald-400', bg: 'bg-emerald-500/20' },
    author: { border: 'border-amber-500', text: 'text-amber-400', bg: 'bg-amber-500/20' },
    news: { border: 'border-cyan-500', text: 'text-cyan-400', bg: 'bg-cyan-500/20' },
    ratings: { border: 'border-rose-500', text: 'text-rose-400', bg: 'bg-rose-500/20' },
  };
  
  function toggleFilter(filter) {
    const btn = document.querySelector(`[data-filter="${filter}"]`);
    const colors = filterColors[filter];
    
    if (activeFilters.has(filter)) {
      // Deactivate filter
      activeFilters.delete(filter);
      btn.classList.remove(colors.border, colors.text, colors.bg);
      btn.classList.add('border-surface-600', 'text-surface-400');
    } else {
      // Activate filter
      activeFilters.add(filter);
      btn.classList.remove('border-surface-600', 'text-surface-400');
      btn.classList.add(colors.border, colors.text, colors.bg);
    }
    
    updateFilterHint();
  }
  
  function updateFilterHint() {
    const hint = document.getElementById('filter-hint');
    if (activeFilters.size === 0) {
      hint.innerHTML = `Press <kbd class="px-1.5 py-0.5 bg-surface-700 rounded text-surface-300">Enter</kbd> to search all sources, or select filters above`;
    } else {
      const filterList = Array.from(activeFilters).join(', ');
      hint.innerHTML = `Press <kbd class="px-1.5 py-0.5 bg-surface-700 rounded text-surface-300">Enter</kbd> to search: <span class="text-brand-400">${filterList}</span> <button onclick="clearAllFilters()" class="ml-2 text-xs text-surface-500 hover:text-surface-300 underline">(clear)</button>`;
    }
  }
  
  function clearAllFilters() {
    activeFilters.forEach(filter => {
      const btn = document.querySelector(`[data-filter="${filter}"]`);
      const colors = filterColors[filter];
      btn.classList.remove(colors.border, colors.text, colors.bg);
      btn.classList.add('border-surface-600', 'text-surface-400');
    });
    activeFilters.clear();
    updateFilterHint();
  }
  
  // Make filter functions globally accessible
  window.toggleFilter = toggleFilter;
  window.clearAllFilters = clearAllFilters;
  
  function getActiveFiltersParam() {
    if (activeFilters.size === 0) return null;
    return Array.from(activeFilters).join(',');
  }
  
  // Full search using /api/search endpoint (called on Enter)
  async function performFullSearch(query) {
    if (!query || query.length < 2) {
      resultsContainer.classList.add("hidden");
      return;
    }
    
    // Cancel any in-flight request/stream
    if (abortController) {
      abortController.abort();
    }
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }
    
    loadingSpinner.classList.remove("hidden");
    abortController = new AbortController();
    
    // Reset expanded state
    Object.keys(expandedCategories).forEach(key => {
      expandedCategories[key] = false;
    });
    
    try {
      const sourcesParam = getActiveFiltersParam();
      let url = getApiUrl(`/api/search?q=${encodeURIComponent(query)}&limit=10`);
      if (sourcesParam) {
        url += `&sources=${encodeURIComponent(sourcesParam)}`;
      }
      
      console.log(`[Search] Fetching: ${url}`);
      const response = await fetch(url, { signal: abortController.signal });
      
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }
      
      const data = await response.json();
      console.log(`[Search] Got results:`, Object.keys(data).map(k => `${k}:${data[k]?.length || 0}`).join(', '));
      
      renderResults(data, query);
      resultsContainer.classList.remove("hidden");
      
    } catch (error) {
      if (error.name === 'AbortError') {
        console.log('[Search] Request cancelled');
        return;
      }
      console.error('[Search] Error:', error);
      resultsList.innerHTML = `
        <div class="p-8 text-center text-red-400">
          <p>Search failed. Please try again.</p>
          <p class="text-sm text-surface-500 mt-2">${error.message}</p>
        </div>
      `;
      resultsContainer.classList.remove("hidden");
    } finally {
      loadingSpinner.classList.add("hidden");
    }
  }

  // Stream mode toggle
  function toggleStreamMode() {
    streamingEnabled = !streamingEnabled;
    const toggle = document.getElementById("stream-toggle");
    const dot = document.getElementById("stream-toggle-dot");

    if (streamingEnabled) {
      toggle.classList.remove("bg-surface-600");
      toggle.classList.add("bg-brand-500");
      toggle.setAttribute("aria-checked", "true");
      dot.classList.remove("translate-x-0");
      dot.classList.add("translate-x-4");
    } else {
      toggle.classList.remove("bg-brand-500");
      toggle.classList.add("bg-surface-600");
      toggle.setAttribute("aria-checked", "false");
      dot.classList.remove("translate-x-4");
      dot.classList.add("translate-x-0");
    }

    // If there's an active query, re-search with new mode
    if (currentQuery && currentQuery.length >= 2) {
      performSearch(currentQuery);
    }
  }

  function searchFor(query) {
    searchInput.value = query;
    searchInput.dispatchEvent(new Event("input"));
    searchInput.focus();
  }

  function formatYear(item) {
    // Use the normalized year field directly
    if (item.year) {
      return String(item.year);
    }
    return "";
  }

  function getPosterUrl(item) {
    // Use the normalized image field directly
    if (item.image) {
      return item.image;
    }
    return null;
  }

  function getRating(item) {
    // Use the normalized rating field directly
    return item.rating || 0;
  }

  function getTypeLabel(item) {
    // Use the normalized mc_type field (values: "tv", "movie", "person")
    const type = item.mc_type;
    if (type === "tv") return "TV Series";
    if (type === "movie") return "Movie";
    if (type === "person") return "Person";
    return type || "Media";
  }

  function getTypeColor(item) {
    // Use the normalized mc_type field (values: "tv", "movie", "person")
    const type = item.mc_type;
    if (type === "tv") return "bg-blue-500/20 text-blue-400";
    if (type === "movie") return "bg-purple-500/20 text-purple-400";
    if (type === "person") return "bg-green-500/20 text-green-400";
    return "bg-surface-500/20 text-surface-400";
  }

  // Normalize a string for exact match comparison
  // Removes common prefixes like "The", converts to lowercase, removes special chars
  function normalizeForMatch(str) {
    if (!str) return "";
    return str
      .toLowerCase()
      .replace(/^the\s+/i, "")  // Remove leading "The "
      .replace(/[^a-z0-9\s]/g, "")  // Remove special characters
      .replace(/\s+/g, " ")  // Normalize whitespace
      .trim();
  }

  function highlightMatch(text, query) {
    if (!text || !query) return text || "";
    const regex = new RegExp(
      `(${query.replace(/[.*+?^${}()|[\]\\]/g, "\\$&")})`,
      "gi"
    );
    return text.replace(
      regex,
      '<mark class="bg-brand-500/30 text-white rounded px-0.5">$1</mark>'
    );
  }

  // Track expanded state for each category
  const expandedCategories = { tv: false, movie: false, person: false, podcast: false, author: false, book: false };

  function toggleCategoryExpand(category) {
    expandedCategories[category] = !expandedCategories[category];
    const isExpanded = expandedCategories[category];

    // Find the category section in the DOM
    const section = document.querySelector(`.category-section[data-category="${category}"]`);
    if (!section) return;

    // Toggle visibility of hidden items (items with data-hidden="true")
    const hiddenItems = section.querySelectorAll('.category-item[data-hidden="true"]');
    hiddenItems.forEach(item => {
      if (isExpanded) {
        item.classList.remove('hidden');
      } else {
        item.classList.add('hidden');
      }
    });

    // Update the toggle button text and icon
    const toggleBtn = section.querySelector('.expand-toggle-btn');
    if (toggleBtn) {
      const hiddenCount = hiddenItems.length;
      if (isExpanded) {
        toggleBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg> Show less`;
      } else {
        toggleBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg> Show ${hiddenCount} more`;
      }
    }
  }

  // Make toggleCategoryExpand globally accessible
  window.toggleCategoryExpand = toggleCategoryExpand;

  function renderResults(results, query) {
    // Store for re-render on expand/collapse
    window._lastResults = results;
    window._lastQuery = query;

    // Handle categorized results format: {tv: [], movie: [], person: []}
    const categories = [];

    if (results && typeof results === "object" && !Array.isArray(results)) {
      // Build category objects with items, popularity, and tier
      // Tier 1: Media (TV, Movie, Podcast, Book) - sorted by popularity within tier
      // Tier 2: People (Person, Author) - sorted by popularity within tier
      // Tier 3: News - fixed position
      // Tier 4: Video - fixed position (last)
      if (results.tv && results.tv.length > 0) {
        categories.push({
          key: "tv",
          label: "üì∫ TV Shows",
          items: results.tv,
          topPopularity: parseFloat(results.tv[0]?.popularity) || 0,
          color: "blue",
          tier: 1,  // Media tier
        });
      }
      if (results.movie && results.movie.length > 0) {
        categories.push({
          key: "movie",
          label: "üé¨ Movies",
          items: results.movie,
          topPopularity: parseFloat(results.movie[0]?.popularity) || 0,
          color: "purple",
          tier: 1,  // Media tier
        });
      }
      if (results.person && results.person.length > 0) {
        categories.push({
          key: "person",
          label: "üë§ People",
          items: results.person,
          topPopularity: parseFloat(results.person[0]?.popularity) || 0,
          color: "green",
          tier: 2,  // People tier
        });
      }
      if (results.podcast && results.podcast.length > 0) {
        categories.push({
          key: "podcast",
          label: "üéôÔ∏è Podcasts",
          items: results.podcast,
          topPopularity: parseFloat(results.podcast[0]?.popularity) || 0,
          color: "pink",
          tier: 1,  // Media tier
        });
      }
      if (results.author && results.author.length > 0) {
        categories.push({
          key: "author",
          label: "‚úçÔ∏è Authors",
          items: results.author,
          topPopularity: parseFloat(results.author[0]?.work_count) || 0,
          color: "amber",
          tier: 2,  // People tier
        });
      }
      if (results.book && results.book.length > 0) {
        categories.push({
          key: "book",
          label: "üìö Books",
          items: results.book,
          topPopularity: parseFloat(results.book[0]?.ratings_count) || 0,
          color: "emerald",
          tier: 1,  // Media tier
        });
      }
      if (results.news && results.news.length > 0) {
        categories.push({
          key: "news",
          label: "üì∞ News",
          items: results.news,
          topPopularity: parseFloat(results.news[0]?.relevance) || 0,
          color: "cyan",
          tier: 3,  // News tier
        });
      }
      if (results.video && results.video.length > 0) {
        categories.push({
          key: "video",
          label: "‚ñ∂Ô∏è Videos",
          items: results.video,
          topPopularity: parseFloat(results.video[0]?.view_count) || 0,
          color: "red",
          tier: 4,  // Video tier (last)
        });
      }
      if (results.ratings && results.ratings.length > 0) {
        categories.push({
          key: "ratings",
          label: "üçÖ Ratings",
          items: results.ratings,
          // Use critics_score for sorting priority
          topPopularity: parseFloat(results.ratings[0]?.critics_score) || 0,
          color: "rose",
          tier: 5,  // Ratings tier (after video)
        });
      }
      if (results.artist && results.artist.length > 0) {
        categories.push({
          key: "artist",
          label: "üé§ Artists",
          items: results.artist,
          // Use popularity for sorting (Spotify popularity 0-100)
          topPopularity: parseFloat(results.artist[0]?.popularity) || 0,
          color: "lime",
          tier: 2,  // People tier (with Person, Author)
        });
      }
      if (results.album && results.album.length > 0) {
        categories.push({
          key: "album",
          label: "üíø Albums",
          items: results.album,
          // Albums don't have popularity, use 0
          topPopularity: 0,
          color: "violet",
          tier: 1,  // Media tier (with TV, Movie, Podcast, Book)
        });
      }

      // Check for exact name matches in person-type categories (artist, author, person)
      // If found, promote that category to tier 0 (top)
      const personCategories = ["artist", "author", "person"];
      const normalizedQuery = normalizeForMatch(query);
      
      for (const cat of categories) {
        if (personCategories.includes(cat.key) && cat.items.length > 0) {
          // Check if first item is an exact match
          const firstItem = cat.items[0];
          const itemName = firstItem.name || firstItem.search_title || firstItem.title || "";
          const normalizedName = normalizeForMatch(itemName);
          
          if (normalizedQuery && normalizedName && normalizedQuery === normalizedName) {
            // Exact match found - promote to tier 0
            cat.tier = 0;
            cat.exactMatch = true;
          }
        }
      }

      // Sort categories by tier first, then by popularity within each tier
      // Tier 0: Exact person match (promoted dynamically)
      // Tier 1: Media (TV, Movie, Podcast, Book, Album) - sorted by popularity
      // Tier 2: People (Person, Author, Artist) - sorted by popularity
      // Tier 3: News - fixed position
      // Tier 4: Video - fixed position
      // Tier 5: Ratings - fixed position (last)
      categories.sort((a, b) => {
        // First sort by tier
        if (a.tier !== b.tier) {
          return a.tier - b.tier;
        }
        // Within same tier, sort by popularity (highest first)
        return b.topPopularity - a.topPopularity;
      });
    } else if (Array.isArray(results) && results.length > 0) {
      // Fallback for flat array format
      categories.push({
        key: "all",
        label: "üîç Results",
        items: results,
        topPopularity: 0,
        color: "brand",
      });
    }

    if (categories.length === 0) {
      resultsList.innerHTML = `
            <div class="p-8 text-center text-surface-500">
                <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p>No results found for "<span class="text-surface-400">${query}</span>"</p>
            </div>
        `;
      return;
    }

    // Render each category section
    resultsList.innerHTML = categories
      .map((category, catIndex) => {
        const isExpanded = expandedCategories[category.key] || false;
        const hasMore = category.items.length > 3;
        const hiddenCount = category.items.length - 3;

        // Render ALL items, but mark items beyond index 2 as hidden (unless expanded)
        const itemsHtml = category.items
          .map((item, index) => {
            const isHiddenItem = index >= 3;
            const hiddenClass = isHiddenItem && !isExpanded ? 'hidden' : '';
            const hiddenAttr = isHiddenItem ? 'data-hidden="true"' : '';
            return `<div class="category-item ${hiddenClass}" ${hiddenAttr}>${renderResultItem(item, index, query)}</div>`;
          })
          .join("");

        return `
        ${catIndex > 0
            ? '<div class="border-t border-surface-700 my-2"></div>'
            : ""
          }
        <div class="category-section" data-category="${category.key}">
          <div class="flex items-center justify-between px-4 py-2 bg-surface-800/50">
            <h4 class="text-sm font-medium text-surface-300">${category.label
          }</h4>
            <span class="text-xs text-surface-500">${category.items.length
          } result${category.items.length !== 1 ? "s" : ""}</span>
          </div>
          <div class="category-items">
            ${itemsHtml}
          </div>
          ${hasMore
            ? `
            <button onclick="toggleCategoryExpand('${category.key}')" 
                    class="expand-toggle-btn w-full py-2 text-sm text-${category.color
            }-400 hover:text-${category.color
            }-300 hover:bg-surface-800/50 transition-colors flex items-center justify-center gap-1">
              ${isExpanded
              ? '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/></svg> Show less'
              : `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg> Show ${hiddenCount} more`
            }
            </button>
          `
            : ""
          }
        </div>
      `;
      })
      .join("");
  }

  function renderResultItem(item, index, query) {
    const title = item.search_title || "Unknown";
    const year = formatYear(item);
    const poster = getPosterUrl(item);
    const rating = getRating(item);
    const overview = item.overview || "";
    const isPerson = item.mc_type === "person";
    const isAuthor = item.mc_subtype === "author";
    const isPodcast = item.mc_type === "podcast";
    const isBook = item.mc_type === "book";
    const isNews = item.mc_type === "news_article";
    const isVideo = item.mc_type === "video" || item.mc_type === "youtube_video";
    const isRating = item.source === "rottentomatoes" || item.critics_score !== undefined;
    const isMusicArtist = item.mc_subtype === "music_artist" || (item.source === "spotify" && item.mc_type === "person");
    const isMusicAlbum = item.mc_type === "music_album" || (item.source === "spotify" && item.title && item.artist);

    // For authors (OpenLibrary), show author-specific info
    if (isAuthor) {
      return renderAuthorItem(item, index, query);
    }

    // For books (OpenLibrary), show book-specific info
    if (isBook) {
      return renderBookItem(item, index, query);
    }

    // For Spotify music artists (check BEFORE isPerson since music artists have mc_type=person)
    if (isMusicArtist) {
      return renderMusicArtistItem(item, index, query);
    }

    // For persons (TMDB), show different info
    if (isPerson) {
      return renderPersonItem(item, index, query);
    }

    // For podcasts, show podcast-specific info
    if (isPodcast) {
      return renderPodcastItem(item, index, query);
    }

    // For news articles (from NewsAI API)
    if (isNews) {
      return renderNewsItem(item, index, query);
    }

    // For YouTube videos (from YouTube API)
    if (isVideo) {
      return renderVideoItem(item, index, query);
    }

    // For RottenTomatoes ratings (from RT API)
    if (isRating) {
      return renderRatingItem(item, index, query);
    }

    // For Spotify music albums
    if (isMusicAlbum) {
      return renderMusicAlbumItem(item, index, query);
    }

    // Cast is stored as array of strings directly
    const cast = (item.cast || []).slice(0, 3).join(", ");

    // source_id is the numeric TMDB ID stored in the index
    const sourceId = item.source_id || "";

    return `
        <div class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
             data-media-id="${item.id}"
             data-source-id="${sourceId}"
             data-mc-type="${item.mc_type || ""}"
             data-mc-subtype="${item.mc_subtype || ""}"
             style="animation-delay: ${index * 30}ms">
            <!-- Poster -->
            <div class="flex-shrink-0 w-12 h-18 rounded-lg overflow-hidden bg-surface-800">
                ${poster
        ? `<img src="${poster}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-surface-600\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-surface-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-brand-400 transition-colors truncate text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs">
                            ${year
        ? `<span class="text-surface-500">${year}</span>`
        : ""
      }
                            ${rating > 0
        ? `
                                <span class="flex items-center gap-1 text-surface-400">
                                    <svg class="w-3 h-3 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                    </svg>
                                    ${rating.toFixed(1)}
                                </span>
                            `
        : ""
      }
                        </div>
                    </div>
                </div>
                ${cast
        ? `
                    <p class="mt-0.5 text-xs text-surface-500 truncate">${cast}</p>
                `
        : ""
      }
            </div>
            
            <!-- Arrow -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `;
  }

  function renderPersonItem(item, index, query) {
    const name = item.search_title || "Unknown";
    const poster = getPosterUrl(item);
    const department = item.known_for_department || "";
    const age = item.age;
    const isDeceased = item.is_deceased;
    const overview = item.overview || "";
    const knownForTitles = item.known_for_titles || [];

    // Format department display (capitalize first letter)
    const departmentDisplay = department
      ? department.charAt(0).toUpperCase() + department.slice(1).toLowerCase()
      : "";

    // Format age display
    let ageDisplay = "";
    if (age) {
      if (isDeceased) {
        ageDisplay = `Died at ${age}`;
      } else {
        ageDisplay = `Age ${age}`;
      }
    }

    // Truncate biography to ~80 chars with ellipsis
    let bioSnippet = "";
    if (overview) {
      if (overview.length > 80) {
        bioSnippet = overview.substring(0, 80).trim() + "...";
      } else {
        bioSnippet = overview;
      }
    }

    // Known for titles
    const knownForDisplay =
      knownForTitles.length > 0 ? knownForTitles.join(", ") : "";

    // source_id is the numeric TMDB ID stored in the index
    const sourceId = item.source_id || "";

    return `
        <div class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
             data-media-id="${item.id}"
             data-source-id="${sourceId}"
             data-mc-type="person"
             data-mc-subtype="${item.mc_subtype || ""}"
             style="animation-delay: ${index * 30}ms">
            <!-- Profile Photo -->
            <div class="flex-shrink-0 w-12 h-12 rounded-full overflow-hidden bg-surface-800">
                ${poster
        ? `<img src="${poster}" alt="${name}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-surface-600 text-lg font-medium\\'>${name.charAt(
          0
        )}</div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-surface-400 text-lg font-medium">
                        ${name.charAt(0)}
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-brand-400 transition-colors truncate text-sm">
                            ${highlightMatch(name, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            ${departmentDisplay
        ? `<span class="text-green-400 font-medium">${departmentDisplay}</span>`
        : ""
      }
                            ${ageDisplay
        ? `<span class="text-surface-500">${ageDisplay}</span>`
        : ""
      }
                        </div>
                    </div>
                </div>
                ${bioSnippet
        ? `<p class="mt-1 text-xs text-surface-400 line-clamp-2">${bioSnippet}</p>`
        : ""
      }
                ${knownForDisplay
        ? `<p class="mt-0.5 text-xs text-surface-500 truncate">Known for: ${knownForDisplay}</p>`
        : ""
      }
            </div>
            
            <!-- Arrow -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `;
  }

  function renderPodcastItem(item, index, query) {
    const title = item.search_title || item.title || "Unknown Podcast";
    const author = item.author || "";
    const image = item.image || "";
    const episodeCount = item.episode_count || 0;
    const overview = item.overview || "";
    const language = item.language || "";

    // Format episode count display
    const episodeDisplay = episodeCount > 0 ? `${episodeCount.toLocaleString()} episodes` : "";

    // Truncate description to ~80 chars with ellipsis
    let descSnippet = "";
    if (overview) {
      if (overview.length > 80) {
        descSnippet = overview.substring(0, 80).trim() + "...";
      } else {
        descSnippet = overview;
      }
    }

    // Get first category if available
    const categories = item.categories || {};
    const firstCategory = Object.values(categories)[0] || "";

    return `
        <div class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
             data-media-id="${item.id}"
             data-source-id="${item.source_id || ""}"
             data-mc-type="podcast"
             data-mc-subtype=""
             style="animation-delay: ${index * 30}ms">
            <!-- Podcast Artwork -->
            <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden bg-surface-800">
                ${image
        ? `<img src="${image}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-surface-600\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-surface-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-brand-400 transition-colors truncate text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            ${author
        ? `<span class="text-pink-400 font-medium truncate max-w-[150px]">${author}</span>`
        : ""
      }
                            ${episodeDisplay
        ? `<span class="text-surface-500">${episodeDisplay}</span>`
        : ""
      }
                        </div>
                    </div>
                </div>
                ${descSnippet
        ? `<p class="mt-1 text-xs text-surface-400 line-clamp-2">${descSnippet}</p>`
        : ""
      }
                ${firstCategory
        ? `<p class="mt-0.5 text-xs text-surface-500 truncate">${firstCategory}</p>`
        : ""
      }
            </div>
            
            <!-- Arrow -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `;
  }

  function renderNewsItem(item, index, query) {
    const title = item.title || "Unknown Article";
    const description = item.description || "";
    const url = item.url || "#";
    const image = item.url_to_image || "";
    const publishedAt = item.published_at || "";
    const author = item.author || "";
    const newsSource = item.news_source || {};
    const sourceName = newsSource.name || "Unknown Source";

    // Format publication date
    let dateDisplay = "";
    if (publishedAt) {
      try {
        const date = new Date(publishedAt);
        const now = new Date();
        const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
        if (diffHours < 1) {
          dateDisplay = "Just now";
        } else if (diffHours < 24) {
          dateDisplay = `${diffHours}h ago`;
        } else {
          const diffDays = Math.floor(diffHours / 24);
          if (diffDays === 1) {
            dateDisplay = "Yesterday";
          } else if (diffDays < 7) {
            dateDisplay = `${diffDays}d ago`;
          } else {
            dateDisplay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
          }
        }
      } catch (e) {
        dateDisplay = "";
      }
    }

    // Truncate description to ~100 chars with ellipsis
    let descSnippet = "";
    if (description) {
      if (description.length > 100) {
        descSnippet = description.substring(0, 100).trim() + "...";
      } else {
        descSnippet = description;
      }
    }

    return `
        <a href="${url}" target="_blank" rel="noopener noreferrer" 
           class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
           style="animation-delay: ${index * 30}ms">
            <!-- Article Image -->
            <div class="flex-shrink-0 w-16 h-12 rounded-lg overflow-hidden bg-surface-800">
                ${image
        ? `<img src="${image}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-cyan-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-cyan-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-cyan-400 transition-colors line-clamp-2 text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            <span class="text-cyan-400 font-medium truncate max-w-[120px]">${sourceName}</span>
                            ${dateDisplay
        ? `<span class="text-surface-500">${dateDisplay}</span>`
        : ""
      }
                            ${author
        ? `<span class="text-surface-500 truncate max-w-[100px]">by ${author}</span>`
        : ""
      }
                        </div>
                    </div>
                </div>
                ${descSnippet
        ? `<p class="mt-1 text-xs text-surface-400 line-clamp-2">${descSnippet}</p>`
        : ""
      }
            </div>
            
            <!-- External link icon -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
            </div>
        </a>
    `;
  }

  function renderVideoItem(item, index, query) {
    const title = item.title || "Unknown Video";
    const channelTitle = item.channel_title || "";
    const url = item.url || "#";
    const thumbnail = item.thumbnail_url || "";
    const viewCount = item.view_count || 0;
    const publishedAt = item.published_at || "";
    const duration = item.duration || "";

    // Format view count (e.g., 1.2M, 500K, 1,234)
    let viewDisplay = "";
    if (viewCount > 0) {
      if (viewCount >= 1000000) {
        viewDisplay = `${(viewCount / 1000000).toFixed(1)}M views`;
      } else if (viewCount >= 1000) {
        viewDisplay = `${(viewCount / 1000).toFixed(0)}K views`;
      } else {
        viewDisplay = `${viewCount.toLocaleString()} views`;
      }
    }

    // Format publication date (relative time)
    let dateDisplay = "";
    if (publishedAt) {
      try {
        const date = new Date(publishedAt);
        const now = new Date();
        const diffHours = Math.floor((now - date) / (1000 * 60 * 60));
        if (diffHours < 1) {
          dateDisplay = "Just now";
        } else if (diffHours < 24) {
          dateDisplay = `${diffHours}h ago`;
        } else {
          const diffDays = Math.floor(diffHours / 24);
          if (diffDays === 1) {
            dateDisplay = "Yesterday";
          } else if (diffDays < 7) {
            dateDisplay = `${diffDays}d ago`;
          } else if (diffDays < 30) {
            dateDisplay = `${Math.floor(diffDays / 7)}w ago`;
          } else if (diffDays < 365) {
            dateDisplay = `${Math.floor(diffDays / 30)}mo ago`;
          } else {
            dateDisplay = `${Math.floor(diffDays / 365)}y ago`;
          }
        }
      } catch (e) {
        dateDisplay = "";
      }
    }

    // Format duration (PT1H2M30S -> 1:02:30)
    let durationDisplay = "";
    if (duration) {
      try {
        const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (match) {
          const hours = parseInt(match[1] || 0);
          const minutes = parseInt(match[2] || 0);
          const seconds = parseInt(match[3] || 0);
          if (hours > 0) {
            durationDisplay = `${hours}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
          } else {
            durationDisplay = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          }
        }
      } catch (e) {
        durationDisplay = "";
      }
    }

    return `
        <a href="${url}" target="_blank" rel="noopener noreferrer" 
           class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
           style="animation-delay: ${index * 30}ms">
            <!-- Video Thumbnail -->
            <div class="flex-shrink-0 w-24 h-14 rounded-lg overflow-hidden bg-surface-800 relative">
                ${thumbnail
        ? `<img src="${thumbnail}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-red-500\\'><svg class=\\'w-8 h-8\\' fill=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path d=\\'M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-red-500">
                        <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                        </svg>
                    </div>`
      }
                ${durationDisplay
        ? `<span class="absolute bottom-1 right-1 bg-black/80 text-white text-xs px-1 rounded">${durationDisplay}</span>`
        : ""
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-red-400 transition-colors line-clamp-2 text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            ${channelTitle
        ? `<span class="text-red-400 font-medium truncate max-w-[150px]">${channelTitle}</span>`
        : ""
      }
                            ${viewDisplay
        ? `<span class="text-surface-500">${viewDisplay}</span>`
        : ""
      }
                            ${dateDisplay
        ? `<span class="text-surface-500">${dateDisplay}</span>`
        : ""
      }
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- YouTube icon / External link -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
                </svg>
            </div>
        </a>
    `;
  }

  function renderRatingItem(item, index, query) {
    const title = item.title || "Unknown Title";
    const year = item.release_year || "";
    const poster = item.poster_url || "";
    const rtUrl = item.rt_url || "#";
    const criticsScore = item.critics_score;
    const audienceScore = item.audience_score;
    const criticsSentiment = item.critics_sentiment || "";
    const audienceSentiment = item.audience_sentiment || "";
    const certifiedFresh = item.certified_fresh || false;
    const mediaType = item.mc_type === "tv" || item.mc_type === "tv_series" ? "TV" : "Movie";
    const genres = (item.genres || []).slice(0, 2).join(", ");

    // Determine tomato icon/color based on critics sentiment
    let tomatoIcon = "üçÖ";  // Fresh
    let tomatoColor = "text-red-500";
    if (criticsScore !== null && criticsScore !== undefined) {
      if (certifiedFresh) {
        tomatoIcon = "üèÜ";  // Certified Fresh
        tomatoColor = "text-yellow-500";
      } else if (criticsScore < 60) {
        tomatoIcon = "üü¢";  // Rotten (using green splat emoji)
        tomatoColor = "text-green-600";
      }
    }

    // Determine audience icon
    let audienceIcon = "üçø";
    let audienceColor = "text-yellow-400";
    if (audienceScore !== null && audienceScore !== undefined && audienceScore < 60) {
      audienceIcon = "üçø";
      audienceColor = "text-surface-500";
    }

    return `
        <a href="${rtUrl}" target="_blank" rel="noopener noreferrer" 
           class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
           style="animation-delay: ${index * 30}ms">
            <!-- Poster -->
            <div class="flex-shrink-0 w-12 h-16 rounded-lg overflow-hidden bg-surface-800">
                ${poster
        ? `<img src="${poster}" alt="" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-rose-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-rose-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-rose-400 transition-colors truncate text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            ${year ? `<span class="text-surface-500">${year}</span>` : ""}
                            ${mediaType ? `<span class="text-rose-400">${mediaType}</span>` : ""}
                            ${genres ? `<span class="text-surface-500">${genres}</span>` : ""}
                        </div>
                    </div>
                    
                    <!-- Scores -->
                    <div class="flex items-center gap-3 flex-shrink-0">
                        ${criticsScore !== null && criticsScore !== undefined
        ? `<div class="flex items-center gap-1">
                                <span class="text-sm">${tomatoIcon}</span>
                                <span class="${criticsScore >= 60 ? 'text-red-400' : 'text-green-600'} font-bold text-sm">${criticsScore}%</span>
                            </div>`
        : ""
      }
                        ${audienceScore !== null && audienceScore !== undefined
        ? `<div class="flex items-center gap-1">
                                <span class="text-sm">${audienceIcon}</span>
                                <span class="${audienceScore >= 60 ? 'text-yellow-400' : 'text-surface-500'} font-bold text-sm">${audienceScore}%</span>
                            </div>`
        : ""
      }
                    </div>
                </div>
            </div>
            
            <!-- RT Link icon -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
            </div>
        </a>
    `;
  }

  function renderMusicArtistItem(item, index, query) {
    const name = item.name || item.title || "Unknown Artist";
    const image = item.default_image || item.image || "";
    const spotifyUrl = item.spotify_url || "#";
    const popularity = item.popularity || 0;
    const followers = item.followers || 0;
    const genres = (item.genres || []).slice(0, 3).join(", ");
    const knownFor = item.known_for || item.top_track_track || "";

    // Format followers count
    let followersDisplay = "";
    if (followers > 0) {
      if (followers >= 1000000) {
        followersDisplay = `${(followers / 1000000).toFixed(1)}M followers`;
      } else if (followers >= 1000) {
        followersDisplay = `${(followers / 1000).toFixed(0)}K followers`;
      } else {
        followersDisplay = `${followers.toLocaleString()} followers`;
      }
    }

    return `
        <a href="${spotifyUrl}" target="_blank" rel="noopener noreferrer" 
           class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
           style="animation-delay: ${index * 30}ms">
            <!-- Artist Photo -->
            <div class="flex-shrink-0 w-12 h-12 rounded-full overflow-hidden bg-surface-800">
                ${image
        ? `<img src="${image}" alt="${name}" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-lime-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-lime-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-lime-400 transition-colors truncate text-sm">
                            ${highlightMatch(name, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            ${genres ? `<span class="text-lime-400">${genres}</span>` : ""}
                            ${followersDisplay ? `<span class="text-surface-500">${followersDisplay}</span>` : ""}
                        </div>
                        ${knownFor ? `<div class="text-xs text-surface-500 mt-0.5 truncate">Known for: ${knownFor}</div>` : ""}
                    </div>
                    
                    <!-- Popularity indicator -->
                    ${popularity > 0
        ? `<div class="flex-shrink-0 flex items-center gap-1">
                            <div class="w-8 h-1.5 bg-surface-700 rounded-full overflow-hidden">
                                <div class="h-full bg-lime-500 rounded-full" style="width: ${popularity}%"></div>
                            </div>
                        </div>`
        : ""
      }
                </div>
            </div>
            
            <!-- Spotify icon -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-5 h-5 text-lime-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
            </div>
        </a>
    `;
  }

  function renderMusicAlbumItem(item, index, query) {
    const title = item.title || "Unknown Album";
    const artist = item.artist || "Unknown Artist";
    const image = item.default_image || "";
    const spotifyUrl = item.spotify_url || "#";
    const releaseDate = item.release_date || "";
    const totalTracks = item.total_tracks || 0;

    // Format release year from date
    let releaseYear = "";
    if (releaseDate) {
      releaseYear = releaseDate.split("-")[0];
    }

    return `
        <a href="${spotifyUrl}" target="_blank" rel="noopener noreferrer" 
           class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
           style="animation-delay: ${index * 30}ms">
            <!-- Album Cover -->
            <div class="flex-shrink-0 w-12 h-12 rounded-lg overflow-hidden bg-surface-800">
                ${image
        ? `<img src="${image}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-violet-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3\\'/></svg></div>'">`
        : `<div class="w-full h-full flex items-center justify-center text-violet-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-violet-400 transition-colors truncate text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            <span class="text-violet-400 truncate max-w-[150px]">${artist}</span>
                            ${releaseYear ? `<span class="text-surface-500">${releaseYear}</span>` : ""}
                            ${totalTracks > 0 ? `<span class="text-surface-500">${totalTracks} tracks</span>` : ""}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Spotify icon -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-5 h-5 text-violet-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                </svg>
            </div>
        </a>
    `;
  }

  function renderAuthorItem(item, index, query) {
    const name = item.search_title || item.name || "Unknown Author";
    const photoUrls = item.photo_urls || {};
    // Use photo_urls.openlibrary first, then item.image, then wikidata as fallback
    const image = photoUrls.openlibrary || item.image || "";
    const fallbackImage = photoUrls.wikidata || "";
    const birthDate = item.birth_date || "";
    const deathDate = item.death_date || "";
    const bio = item.bio || "";
    const openlibraryUrl = item.openlibrary_url || "";

    // Format life dates
    let lifeDates = "";
    if (birthDate) {
      lifeDates = `Born ${birthDate}`;
      if (deathDate) {
        lifeDates += ` ¬∑ Died ${deathDate}`;
      }
    }

    // Truncate bio for display
    const bioSnippet = bio.length > 100 ? bio.substring(0, 100) + "..." : bio;

    // source_id for detail view
    const sourceId = item.source_id || "";

    return `
        <div class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
             data-media-id="${item.id}"
             data-source-id="${sourceId}"
             data-mc-type="${item.mc_type || "person"}"
             data-mc-subtype="${item.mc_subtype || "author"}"
             ${openlibraryUrl ? `data-external-url="${openlibraryUrl}"` : ""}
             style="animation-delay: ${index * 30}ms">
            <!-- Author Photo -->
            <div class="flex-shrink-0 w-12 h-12 rounded-full overflow-hidden bg-surface-800">
                ${image
        ? `<img src="${image}" alt="${name}" class="w-full h-full object-cover" loading="lazy" data-fallback="${fallbackImage}" onload="var img=this; setTimeout(function(){ if(img.naturalWidth<=1||img.naturalHeight<=1){ if(img.dataset.fallback&&!img.dataset.triedFallback){ img.dataset.triedFallback='true'; img.src=img.dataset.fallback; } else { img.style.display='none'; img.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-amber-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\\'/></svg></div>'; }}},0);" onerror="if(this.dataset.fallback && !this.dataset.triedFallback) { this.dataset.triedFallback='true'; this.src=this.dataset.fallback; } else { this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-amber-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\\'/></svg></div>'; }'">`
        : `<div class="w-full h-full flex items-center justify-center text-amber-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-amber-400 transition-colors truncate text-sm">
                            ${highlightMatch(name, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            <span class="text-amber-500 font-medium">Author</span>
                            ${lifeDates
        ? `<span class="text-surface-500">${lifeDates}</span>`
        : ""
      }
                        </div>
                    </div>
                </div>
                ${bioSnippet
        ? `<p class="mt-1 text-xs text-surface-400 line-clamp-2">${bioSnippet}</p>`
        : ""
      }
            </div>
            
            <!-- Arrow / OpenLibrary link -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `;
  }

  function renderBookItem(item, index, query) {
    const title = item.search_title || item.title || "Unknown Book";
    const author = item.author || item.author_search || "";
    const cover_i = item.cover_i;
    const coverUrl = cover_i ? `https://covers.openlibrary.org/b/id/${cover_i}-M.jpg` : "";
    const firstPublishYear = item.first_publish_year;
    const description = item.description || "";
    const subjects = item.subjects || [];
    const ratingsAverage = item.ratings_average;
    const ratingsCount = item.ratings_count;
    const openlibraryKey = item.openlibrary_key || item.key;
    const openlibraryUrl = openlibraryKey ? `https://openlibrary.org${openlibraryKey}` : "";

    // Format year display
    const yearDisplay = firstPublishYear ? `${firstPublishYear}` : "";

    // Truncate description for display
    const descSnippet = description.length > 100 ? description.substring(0, 100) + "..." : description;

    // Format rating display
    let ratingDisplay = "";
    if (ratingsAverage && ratingsCount) {
      ratingDisplay = `${ratingsAverage.toFixed(1)} (${ratingsCount.toLocaleString()} ratings)`;
    }

    // Format subjects
    const subjectsDisplay = subjects.slice(0, 3).join(", ");

    // source_id for detail view
    const sourceId = item.source_id || "";

    return `
        <div class="group flex gap-4 p-3 hover:bg-surface-800/50 cursor-pointer transition-colors border-b border-surface-800/50 last:border-b-0"
             data-media-id="${item.id}"
             data-source-id="${sourceId}"
             data-mc-type="book"
             ${openlibraryUrl ? `data-external-url="${openlibraryUrl}"` : ""}
             style="animation-delay: ${index * 30}ms">
            <!-- Book Cover -->
            <div class="flex-shrink-0 w-12 h-16 rounded overflow-hidden bg-surface-800">
                ${coverUrl
        ? `<img src="${coverUrl}" alt="${title}" class="w-full h-full object-cover" loading="lazy" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-emerald-500\\'><svg class=\\'w-6 h-6\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\\'/></svg></div>';">`
        : `<div class="w-full h-full flex items-center justify-center text-emerald-500">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>`
      }
            </div>
            
            <!-- Content -->
            <div class="flex-1 min-w-0">
                <div class="flex items-start justify-between gap-2">
                    <div class="min-w-0">
                        <h3 class="font-medium text-white group-hover:text-emerald-400 transition-colors truncate text-sm">
                            ${highlightMatch(title, query)}
                        </h3>
                        <div class="flex items-center gap-2 mt-0.5 text-xs flex-wrap">
                            ${author
        ? `<span class="text-emerald-500 font-medium truncate max-w-32">${author}</span>`
        : ""
      }
                            ${yearDisplay
        ? `<span class="text-surface-500">${yearDisplay}</span>`
        : ""
      }
                            ${ratingDisplay
        ? `<span class="text-yellow-500">‚òÖ ${ratingDisplay}</span>`
        : ""
      }
                        </div>
                    </div>
                </div>
                ${descSnippet
        ? `<p class="mt-1 text-xs text-surface-400 line-clamp-2">${descSnippet}</p>`
        : ""
      }
                ${subjectsDisplay
        ? `<p class="mt-0.5 text-xs text-surface-500 truncate">${subjectsDisplay}</p>`
        : ""
      }
            </div>
            
            <!-- Arrow -->
            <div class="flex-shrink-0 self-center opacity-0 group-hover:opacity-100 transition-opacity">
                <svg class="w-4 h-4 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                </svg>
            </div>
        </div>
    `;
  }

  async function performSearch(query) {
    if (!query || query.length < 2) {
      resultsContainer.classList.add("hidden");
      return;
    }

    // Cancel any in-flight request/stream before starting a new one
    if (abortController) {
      abortController.abort();
    }
    if (eventSource) {
      eventSource.close();
      eventSource = null;
    }

    loadingSpinner.classList.remove("hidden");

    // Reset expanded state for new search
    Object.keys(expandedCategories).forEach(key => {
      expandedCategories[key] = false;
    });

    if (streamingEnabled) {
      performStreamingSearch(query);
    } else {
      performRegularSearch(query);
    }
  }

  // Regular (non-streaming) search
  async function performRegularSearch(query) {
    abortController = new AbortController();
    const signal = abortController.signal;

    try {
      // Build URL with optional sources filter
      const sourcesParam = getSourcesParam();
      const url = sourcesParam
        ? getApiUrl(`/api/autocomplete?q=${encodeURIComponent(query)}&sources=${sourcesParam}`)
        : getApiUrl(`/api/autocomplete?q=${encodeURIComponent(query)}`);

      const response = await fetch(url, { signal });
      const results = await response.json();

      if (query === currentQuery) {
        renderResults(results, query);
        resultsContainer.classList.remove("hidden");
      }
    } catch (error) {
      // Ignore abort errors - they're expected when user types quickly
      if (error.name === 'AbortError') {
        console.debug(`Request for "${query}" was cancelled`);
        return;
      }
      console.error("Search error:", error);
      resultsList.innerHTML = `
            <div class="p-8 text-center text-red-400">
                <p>Search failed. Please try again.</p>
            </div>
        `;
      resultsContainer.classList.remove("hidden");
    } finally {
      loadingSpinner.classList.add("hidden");
    }
  }

  // Streaming search using Server-Sent Events
  function performStreamingSearch(query) {
    // Initialize empty results structure
    const streamingResults = {
      tv: [],
      movie: [],
      person: [],
      podcast: [],
      author: [],
      book: [],
      news: [],
      video: [],
      ratings: [],
      artist: [],
      album: []
    };
    let sourcesReceived = 0;
    const startTime = performance.now();

    // Show empty results container immediately
    renderResults(streamingResults, query);
    resultsContainer.classList.remove("hidden");

    // Build URL with optional sources filter
    const sourcesParam = getSourcesParam();
    const url = sourcesParam
      ? getApiUrl(`/api/autocomplete/stream?q=${encodeURIComponent(query)}&sources=${sourcesParam}`)
      : getApiUrl(`/api/autocomplete/stream?q=${encodeURIComponent(query)}`);
    eventSource = new EventSource(url);

    eventSource.addEventListener('result', (e) => {
      if (query !== currentQuery) {
        // Query changed, ignore this result
        return;
      }

      try {
        const { source, results, latency_ms } = JSON.parse(e.data);
        sourcesReceived++;

        // Update streaming results
        if (streamingResults.hasOwnProperty(source)) {
          streamingResults[source] = results;
        }

        // Re-render with updated results
        renderResults(streamingResults, query);

        console.debug(`[Stream] ${source}: ${results.length} results in ${latency_ms}ms (${sourcesReceived} sources)`);
      } catch (err) {
        console.error("Error parsing stream event:", err);
      }
    });

    eventSource.addEventListener('done', () => {
      const totalTime = Math.round(performance.now() - startTime);
      console.log(`[Stream] Complete: ${sourcesReceived} sources in ${totalTime}ms`);
      loadingSpinner.classList.add("hidden");
      eventSource.close();
      eventSource = null;
    });

    eventSource.addEventListener('error', (e) => {
      console.error("Stream error:", e);
      loadingSpinner.classList.add("hidden");
      if (eventSource) {
        eventSource.close();
        eventSource = null;
      }
    });
  }

  searchInput.addEventListener("input", (e) => {
    const query = e.target.value.trim();
    currentQuery = query;

    clearTimeout(debounceTimer);

    if (!query || query.length < 2) {
      resultsContainer.classList.add("hidden");
      return;
    }

    debounceTimer = setTimeout(() => {
      performSearch(query);
    }, 150);
  });

  // Close results when clicking outside
  document.addEventListener("click", (e) => {
    if (!document.getElementById("search-container").contains(e.target)) {
      resultsContainer.classList.add("hidden");
    }
  });

  // Handle keyboard shortcuts
  searchInput.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      resultsContainer.classList.add("hidden");
      searchInput.blur();
    }
    // Enter key triggers full search with filters
    if (e.key === "Enter") {
      e.preventDefault();
      const query = searchInput.value.trim();
      if (query.length >= 2) {
        // Clear debounce timer to prevent autocomplete from running
        clearTimeout(debounceTimer);
        performFullSearch(query);
      }
    }
  });

  // Re-show results when focusing input with existing query
  searchInput.addEventListener("focus", () => {
    if (searchInput.value.trim().length >= 2) {
      performSearch(searchInput.value.trim());
    }
  });

  // ===== Modal functionality =====
  const modal = document.getElementById("detail-modal");
  const modalBackdrop = document.getElementById("modal-backdrop");
  const modalClose = document.getElementById("modal-close");
  const modalLoading = document.getElementById("modal-loading");
  const modalBody = document.getElementById("modal-body");

  function openModal(mediaId, sourceId, mcType, mcSubtype) {
    modal.classList.remove("hidden");
    modalLoading.classList.remove("hidden");
    modalBody.classList.add("hidden");
    document.body.style.overflow = "hidden";

    fetchMediaDetail(mediaId, sourceId, mcType, mcSubtype);
  }

  function closeModal() {
    modal.classList.add("hidden");
    document.body.style.overflow = "";
  }

  modalBackdrop.addEventListener("click", closeModal);
  modalClose.addEventListener("click", closeModal);

  // Iframe modal elements
  const iframeModal = document.getElementById("iframe-modal");
  const iframeModalBackdrop = document.getElementById("iframe-modal-backdrop");
  const iframeModalClose = document.getElementById("iframe-modal-close");
  const iframeContent = document.getElementById("iframe-content");
  const iframeModalTitle = document.getElementById("iframe-modal-title");
  const iframeOpenExternal = document.getElementById("iframe-open-external");

  function openExternalLinkModal(url, title) {
    iframeModalTitle.textContent = title;
    iframeContent.src = url;
    iframeOpenExternal.href = url;
    iframeModal.classList.remove("hidden");
    document.body.style.overflow = "hidden";
  }

  // Make it globally accessible for onclick handlers
  window.openExternalLinkModal = openExternalLinkModal;

  function closeIframeModal() {
    iframeModal.classList.add("hidden");
    iframeContent.src = "about:blank";
    document.body.style.overflow = "";
  }

  iframeModalBackdrop.addEventListener("click", closeIframeModal);
  iframeModalClose.addEventListener("click", closeIframeModal);

  // Handle Escape key for both modals
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") {
      if (!iframeModal.classList.contains("hidden")) {
        closeIframeModal();
      } else if (!modal.classList.contains("hidden")) {
        closeModal();
      }
    }
  });

  async function fetchMediaDetail(mediaId, sourceId, mcType, mcSubtype) {
    try {
      // Use the /api/details endpoint with POST
      const params = new URLSearchParams({
        mc_id: mediaId,
        source_id: sourceId,
        mc_type: mcType || "movie",
      });
      if (mcSubtype) params.append("mc_subtype", mcSubtype);

      const response = await fetch(`/api/details?${params.toString()}`, {
        method: "POST",
      });
      const data = await response.json();

      if (response.ok) {
        if (mcSubtype === "author") {
          renderAuthorDetail(data);
        } else if (mcType === "book") {
          renderBookDetail(data);
        } else if (mcType === "person") {
          renderPersonDetail(data);
        } else if (mcType === "podcast") {
          renderPodcastDetail(data);
        } else {
          renderMediaDetail(data);
        }
      } else {
        modalBody.innerHTML = `
          <div class="p-16 text-center text-red-400">
            <p>Failed to load details: ${data.error || "Unknown error"}</p>
          </div>
        `;
      }
    } catch (error) {
      console.error("Error fetching details:", error);
      modalBody.innerHTML = `
        <div class="p-16 text-center text-red-400">
          <p>Error loading details</p>
        </div>
      `;
    } finally {
      modalLoading.classList.add("hidden");
      modalBody.classList.remove("hidden");
    }
  }

  function formatDate(dateStr) {
    if (!dateStr) return "";
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-US", {
      year: "numeric",
      month: "long",
      day: "numeric",
    });
  }

  function renderMediaDetail(data) {
    const title = data.search_title || data.title || data.name || "Unknown";
    const overview =
      data.full_overview || data.overview || "No description available.";
    const type = data.mc_type;
    const rating = data.rating || data.vote_average || 0;
    const popularity = data.popularity || 0;
    const year = data.year;

    // Use enriched cast with images from TMDB
    const mainCast = data.main_cast || [];
    const tmdbCast = data.tmdb_cast?.cast || [];

    // Use enriched data
    const posterUrl =
      data.image ||
      (data.poster_path
        ? `https://image.tmdb.org/t/p/w342${data.poster_path}`
        : null);
    const backdropUrl = data.backdrop_path
      ? `https://image.tmdb.org/t/p/w1280${data.backdrop_path}`
      : null;
    const genres = data.genres || [];
    const voteCount = data.vote_count || 0;
    const runtime = data.runtime;
    const seasons = data.number_of_seasons;
    const episodes = data.number_of_episodes;
    const status = data.status;
    const tagline = data.tagline;
    const director = data.director?.name || null;

    // Watch providers
    const watchProviders = data.watch_providers || {};
    const streamingPlatform = data.streaming_platform;
    const flatrate = watchProviders.flatrate || [];
    const rent = watchProviders.rent || [];
    const buy = watchProviders.buy || [];

    // Trailers
    const primaryTrailer = data.primary_trailer;
    const trailers = data.trailers || [];

    // Get the best cast data available (prefer tmdbCast with images)
    const castToShow = tmdbCast.length > 0 ? tmdbCast : mainCast;

    modalBody.innerHTML = `
      <!-- Backdrop -->
      ${backdropUrl
        ? `
        <div class="relative h-48 md:h-64 overflow-hidden rounded-t-2xl">
          <img src="${backdropUrl}" alt="" class="w-full h-full object-cover opacity-60">
          <div class="absolute inset-0 bg-gradient-to-t from-surface-900 via-surface-900/60 to-transparent"></div>
        </div>
      `
        : `<div class="h-8"></div>`
      }
      
      <!-- Main Content -->
      <div class="relative px-6 pb-6 ${backdropUrl ? "-mt-24" : "pt-6"}">
        <div class="flex flex-col md:flex-row gap-6">
          <!-- Poster -->
          <div class="flex-shrink-0 mx-auto md:mx-0">
            ${posterUrl
        ? `
              <img src="${posterUrl}" alt="${title}" class="w-40 md:w-48 rounded-xl shadow-2xl border border-surface-700">
            `
        : `
              <div class="w-40 md:w-48 h-60 md:h-72 rounded-xl bg-surface-800 flex items-center justify-center border border-surface-700">
                <svg class="w-16 h-16 text-surface-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                </svg>
              </div>
            `
      }
          </div>
          
          <!-- Info -->
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl md:text-3xl font-bold text-white">${title}</h2>
            
            ${tagline
        ? `<p class="mt-1 text-surface-400 italic">"${tagline}"</p>`
        : ""
      }
            
            <!-- Meta -->
            <div class="flex flex-wrap items-center gap-3 mt-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium ${type === "tv"
        ? "bg-blue-500/20 text-blue-400"
        : "bg-purple-500/20 text-purple-400"
      }">
                ${type === "tv" ? "TV Series" : "Movie"}
              </span>
              ${year ? `<span class="text-surface-400">${year}</span>` : ""}
              ${runtime
        ? `<span class="text-surface-500">${runtime} min</span>`
        : ""
      }
              ${seasons
        ? `<span class="text-surface-500">${seasons} Season${seasons > 1 ? "s" : ""
        }</span>`
        : ""
      }
              ${episodes
        ? `<span class="text-surface-500">${episodes} Episodes</span>`
        : ""
      }
              ${status
        ? `<span class="text-surface-500 capitalize">${status}</span>`
        : ""
      }
            </div>
            
            <!-- Rating -->
            ${rating > 0
        ? `
              <div class="flex items-center gap-3 mt-4">
                <div class="flex items-center gap-1.5 px-3 py-1.5 bg-yellow-500/10 rounded-lg">
                  <svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                  </svg>
                  <span class="font-semibold text-yellow-400">${rating.toFixed(
          1
        )}</span>
                  <span class="text-surface-500 text-sm">/ 10</span>
                </div>
                ${voteCount > 0
          ? `<span class="text-surface-500 text-sm">${voteCount.toLocaleString()} votes</span>`
          : ""
        }
              </div>
            `
        : ""
      }
            
            <!-- Genres -->
            ${genres.length > 0
        ? `
              <div class="flex flex-wrap gap-2 mt-4">
                ${genres
          .map(
            (g) =>
              `<span class="px-3 py-1 bg-surface-800 rounded-full text-sm text-surface-300">${g.name || g
              }</span>`
          )
          .join("")}
              </div>
            `
        : ""
      }
            
            <!-- Overview -->
            <div class="mt-6">
              <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-2">Overview</h3>
              <p class="text-surface-300 leading-relaxed">${overview}</p>
            </div>
            
            <!-- Director -->
            ${director
        ? `<div class="mt-4"><span class="text-surface-500">Directed by</span><span class="text-white ml-1">${director}</span></div>`
        : ""
      }
          </div>
        </div>
        
        <!-- Watch Providers -->
        ${flatrate.length > 0 ||
        rent.length > 0 ||
        buy.length > 0 ||
        streamingPlatform
        ? `
          <div class="mt-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">Where to Watch</h3>
            ${streamingPlatform
          ? `<p class="text-brand-400 mb-3 font-medium">üì∫ ${streamingPlatform}</p>`
          : ""
        }
            ${flatrate.length > 0
          ? `
              <div class="mb-4">
                <p class="text-xs text-surface-500 mb-2">Stream</p>
                <div class="flex flex-wrap gap-2">
                  ${flatrate
            .slice(0, 6)
            .map(
              (p) => `
                    <div class="flex items-center gap-2 px-3 py-2 bg-surface-800 rounded-lg" title="${p.provider_name
                }">
                      ${p.logo_path
                  ? `<img src="https://image.tmdb.org/t/p/w45${p.logo_path}" alt="${p.provider_name}" class="w-6 h-6 rounded">`
                  : ""
                }
                      <span class="text-sm text-surface-300">${p.provider_name
                }</span>
                    </div>
                  `
            )
            .join("")}
                </div>
              </div>
            `
          : ""
        }
            ${rent.length > 0
          ? `
              <div class="mb-4">
                <p class="text-xs text-surface-500 mb-2">Rent</p>
                <div class="flex flex-wrap gap-2">
                  ${rent
            .slice(0, 4)
            .map(
              (p) => `
                    <div class="flex items-center gap-2 px-3 py-2 bg-surface-800 rounded-lg" title="${p.provider_name
                }">
                      ${p.logo_path
                  ? `<img src="https://image.tmdb.org/t/p/w45${p.logo_path}" alt="${p.provider_name}" class="w-6 h-6 rounded">`
                  : ""
                }
                      <span class="text-sm text-surface-300">${p.provider_name
                }</span>
                    </div>
                  `
            )
            .join("")}
                </div>
              </div>
            `
          : ""
        }
            ${buy.length > 0
          ? `
              <div>
                <p class="text-xs text-surface-500 mb-2">Buy</p>
                <div class="flex flex-wrap gap-2">
                  ${buy
            .slice(0, 4)
            .map(
              (p) => `
                    <div class="flex items-center gap-2 px-3 py-2 bg-surface-800 rounded-lg" title="${p.provider_name
                }">
                      ${p.logo_path
                  ? `<img src="https://image.tmdb.org/t/p/w45${p.logo_path}" alt="${p.provider_name}" class="w-6 h-6 rounded">`
                  : ""
                }
                      <span class="text-sm text-surface-300">${p.provider_name
                }</span>
                    </div>
                  `
            )
            .join("")}
                </div>
              </div>
            `
          : ""
        }
          </div>
        `
        : ""
      }
        
        <!-- Trailer -->
        ${primaryTrailer
        ? `
          <div class="mt-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">Trailer</h3>
            <div class="trailer-container relative w-full max-w-xl aspect-video bg-surface-800 rounded-xl overflow-hidden"
                 data-video-url="${primaryTrailer.url}">
              <!-- Thumbnail overlay (shown initially) -->
              <div class="trailer-thumbnail absolute inset-0 cursor-pointer group">
                ${primaryTrailer.thumbnail_url
          ? `<img src="${primaryTrailer.thumbnail_url}" alt="Trailer thumbnail" class="w-full h-full object-cover">`
          : `<div class="w-full h-full bg-surface-800"></div>`
        }
                <div class="absolute inset-0 flex items-center justify-center bg-black/30 group-hover:bg-black/20 transition-colors">
                  <div class="w-16 h-16 rounded-full bg-white/90 flex items-center justify-center group-hover:scale-110 transition-transform">
                    <svg class="w-8 h-8 text-surface-900 ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M8 5v14l11-7z"/>
                    </svg>
                  </div>
                </div>
                <div class="absolute bottom-2 left-2 px-2 py-1 bg-black/70 rounded text-xs text-white">${primaryTrailer.name || "Watch Trailer"}</div>
              </div>
              <!-- YouTube embed (hidden initially, shown when clicked) -->
              <div class="trailer-embed hidden w-full h-full"></div>
            </div>
          </div>
        `
        : ""
      }
        
        <!-- Cast with Images (Clickable) -->
        ${castToShow.length > 0
        ? `
          <div class="mt-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">Cast</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              ${castToShow
          .slice(0, 10)
          .map(
            (c) => `
                <div class="cast-member-card flex flex-col items-center text-center p-3 bg-surface-800/50 rounded-xl hover:bg-surface-700 hover:ring-2 hover:ring-brand-500/50 cursor-pointer transition-all"
                     data-person-id="${c.id}"
                     data-person-name="${c.name}">
                  <div class="w-16 h-16 md:w-20 md:h-20 rounded-full overflow-hidden bg-surface-700 mb-2 flex-shrink-0">
                    ${c.profile_image_url ||
                c.image_url ||
                c.profile_images?.medium
                ? `<img src="${c.profile_image_url ||
                c.image_url ||
                c.profile_images?.medium
                }" alt="${c.name
                }" class="w-full h-full object-cover" onerror="this.parentElement.innerHTML='<div class=\\'w-full h-full flex items-center justify-center text-surface-500 text-xl font-medium\\'>${(
                  c.name || "?"
                ).charAt(0)}</div>'">`
                : `<div class="w-full h-full flex items-center justify-center text-surface-500 text-xl font-medium">${(
                  c.name || "?"
                ).charAt(0)}</div>`
              }
                  </div>
                  <p class="text-sm text-white font-medium truncate w-full">${c.name
              }</p>
                  ${c.character
                ? `<p class="text-xs text-surface-400 truncate w-full mt-0.5">${c.character}</p>`
                : ""
              }
                </div>
              `
          )
          .join("")}
            </div>
          </div>
        `
        : ""
      }
        
        <!-- Technical Info -->
        <div class="mt-8 pt-6 border-t border-surface-800">
          <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Details</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span class="text-surface-500">ID</span>
              <p class="text-surface-300 font-mono text-xs mt-1">${data.id || data.mc_id
      }</p>
            </div>
            ${data.tmdb_id
        ? `<div><span class="text-surface-500">TMDB ID</span><p class="text-surface-300 mt-1">${data.tmdb_id}</p></div>`
        : ""
      }
            ${data.source
        ? `<div><span class="text-surface-500">Source</span><p class="text-surface-300 mt-1">${data.source}</p></div>`
        : ""
      }
            ${popularity
        ? `<div><span class="text-surface-500">Popularity</span><p class="text-surface-300 mt-1">${typeof popularity === "number"
          ? popularity.toFixed(2)
          : popularity
        }</p></div>`
        : ""
      }
          </div>
        </div>
        
        <!-- Raw JSON Toggle -->
        <details class="mt-6">
          <summary class="cursor-pointer text-sm text-surface-500 hover:text-surface-300 transition-colors">
            View Raw JSON
          </summary>
          <pre class="mt-3 p-4 bg-surface-950 rounded-lg overflow-x-auto text-xs text-surface-400 max-h-64 overflow-y-auto"><code>${JSON.stringify(
        data,
        null,
        2
      )}</code></pre>
        </details>
      </div>
    `;
  }

  function renderPersonDetail(data) {
    const name = data.search_title || data.name || "Unknown";
    const biography =
      data.full_overview || data.overview || "No biography available.";
    const department = data.known_for_department || "";
    const birthday = data.birthday;
    const deathday = data.deathday;
    const placeOfBirth = data.place_of_birth;
    const popularity = data.popularity || 0;

    // Profile images
    const profileImages = data.profile_images || {};
    const profileUrl =
      profileImages.large || profileImages.medium || data.image;

    // Credits
    const movieCredits = data.movie_credits || [];
    const tvCredits = data.tv_credits || [];

    // Format department display
    const departmentDisplay = department
      ? department.charAt(0).toUpperCase() + department.slice(1).toLowerCase()
      : "Actor";

    // Calculate age
    let ageDisplay = "";
    if (birthday) {
      const birthDate = new Date(birthday);
      const endDate = deathday ? new Date(deathday) : new Date();
      const age = Math.floor(
        (endDate - birthDate) / (365.25 * 24 * 60 * 60 * 1000)
      );
      if (deathday) {
        ageDisplay = `(${birthday} - ${deathday}, died at ${age})`;
      } else {
        ageDisplay = `(${birthday}, age ${age})`;
      }
    }

    modalBody.innerHTML = `
      <div class="p-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
          <!-- Profile Photo -->
          <div class="flex-shrink-0 mx-auto md:mx-0">
            ${profileUrl
        ? `<img src="${profileUrl}" alt="${name}" class="w-40 md:w-48 rounded-xl shadow-2xl border border-surface-700">`
        : `<div class="w-40 md:w-48 h-60 md:h-72 rounded-xl bg-surface-800 flex items-center justify-center border border-surface-700">
                    <span class="text-6xl text-surface-500 font-medium">${name.charAt(
          0
        )}</span>
                  </div>`
      }
          </div>
          
          <!-- Info -->
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl md:text-3xl font-bold text-white">${name}</h2>
            
            <div class="flex flex-wrap items-center gap-3 mt-3">
              <span class="px-3 py-1 rounded-full text-sm font-medium bg-green-500/20 text-green-400">
                ${departmentDisplay}
              </span>
              ${ageDisplay
        ? `<span class="text-surface-400 text-sm">${ageDisplay}</span>`
        : ""
      }
            </div>
            
            ${placeOfBirth
        ? `<p class="mt-3 text-surface-400 text-sm">üìç ${placeOfBirth}</p>`
        : ""
      }
            
            <!-- Biography -->
            <div class="mt-4">
              <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-2">Biography</h3>
              <p class="text-surface-300 leading-relaxed text-sm">${biography.length > 500
        ? biography.substring(0, 500) + "..."
        : biography
      }</p>
            </div>
          </div>
        </div>
        
        <!-- Movie Credits (Clickable) -->
        ${movieCredits.length > 0
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">üé¨ Movies (${movieCredits.length
        })</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              ${movieCredits
          .slice(0, 10)
          .map(
            (m) => `
                <div class="credit-card group bg-surface-800/50 rounded-lg overflow-hidden hover:bg-surface-700 hover:ring-2 hover:ring-brand-500/50 cursor-pointer transition-all"
                     data-tmdb-id="${m.id}"
                     data-mc-type="movie">
                  <div class="aspect-[2/3] bg-surface-700 overflow-hidden">
                    ${m.poster_path
                ? `<img src="https://image.tmdb.org/t/p/w185${m.poster_path
                }" alt="${m.title || m.name
                }" class="w-full h-full object-cover group-hover:scale-105 transition-transform">`
                : `<div class="w-full h-full flex items-center justify-center text-surface-500">
                          <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                          </svg>
                        </div>`
              }
                  </div>
                  <div class="p-2">
                    <p class="text-sm text-white truncate font-medium">${m.title || m.name
              }</p>
                    ${m.character
                ? `<p class="text-xs text-surface-400 truncate">as ${m.character}</p>`
                : ""
              }
                    ${m.release_date
                ? `<p class="text-xs text-surface-500">${m.release_date.split("-")[0]
                }</p>`
                : ""
              }
                  </div>
                </div>
              `
          )
          .join("")}
            </div>
            ${movieCredits.length > 10
          ? `<p class="text-surface-500 text-sm mt-3">+ ${movieCredits.length - 10
          } more movies</p>`
          : ""
        }
          </div>
        `
        : ""
      }
        
        <!-- TV Credits (Clickable) -->
        ${tvCredits.length > 0
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">üì∫ TV Shows (${tvCredits.length
        })</h3>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
              ${tvCredits
          .slice(0, 10)
          .map(
            (t) => `
                <div class="credit-card group bg-surface-800/50 rounded-lg overflow-hidden hover:bg-surface-700 hover:ring-2 hover:ring-brand-500/50 cursor-pointer transition-all"
                     data-tmdb-id="${t.id}"
                     data-mc-type="tv">
                  <div class="aspect-[2/3] bg-surface-700 overflow-hidden">
                    ${t.poster_path
                ? `<img src="https://image.tmdb.org/t/p/w185${t.poster_path
                }" alt="${t.name || t.title
                }" class="w-full h-full object-cover group-hover:scale-105 transition-transform">`
                : `<div class="w-full h-full flex items-center justify-center text-surface-500">
                          <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 4v16M17 4v16M3 8h4m10 0h4M3 12h18M3 16h4m10 0h4M4 20h16a1 1 0 001-1V5a1 1 0 00-1-1H4a1 1 0 00-1 1v14a1 1 0 001 1z"/>
                          </svg>
                        </div>`
              }
                  </div>
                  <div class="p-2">
                    <p class="text-sm text-white truncate font-medium">${t.name || t.title
              }</p>
                    ${t.character
                ? `<p class="text-xs text-surface-400 truncate">as ${t.character}</p>`
                : ""
              }
                    ${t.first_air_date
                ? `<p class="text-xs text-surface-500">${t.first_air_date.split("-")[0]
                }</p>`
                : ""
              }
                  </div>
                </div>
              `
          )
          .join("")}
            </div>
            ${tvCredits.length > 10
          ? `<p class="text-surface-500 text-sm mt-3">+ ${tvCredits.length - 10
          } more TV shows</p>`
          : ""
        }
          </div>
        `
        : ""
      }
        
        <!-- Technical Info -->
        <div class="pt-6 border-t border-surface-800">
          <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Details</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span class="text-surface-500">ID</span>
              <p class="text-surface-300 font-mono text-xs mt-1">${data.id || data.mc_id
      }</p>
            </div>
            ${data.tmdb_id
        ? `<div><span class="text-surface-500">TMDB ID</span><p class="text-surface-300 mt-1">${data.tmdb_id}</p></div>`
        : ""
      }
            ${popularity
        ? `<div><span class="text-surface-500">Popularity</span><p class="text-surface-300 mt-1">${typeof popularity === "number"
          ? popularity.toFixed(2)
          : popularity
        }</p></div>`
        : ""
      }
          </div>
        </div>
        
        <!-- Raw JSON Toggle -->
        <details class="mt-6">
          <summary class="cursor-pointer text-sm text-surface-500 hover:text-surface-300 transition-colors">
            View Raw JSON
          </summary>
          <pre class="mt-3 p-4 bg-surface-950 rounded-lg overflow-x-auto text-xs text-surface-400 max-h-64 overflow-y-auto"><code>${JSON.stringify(
        data,
        null,
        2
      )}</code></pre>
        </details>
      </div>
    `;
  }

  function renderPodcastDetail(data) {
    const title = data.title || data.search_title || "Unknown Podcast";
    const description = data.description || "No description available.";
    const author = data.author || data.owner_name || "";
    const image = data.artwork || data.image || null;
    const episodeCount = data.episode_count || 0;
    const language = data.language || "";
    const categories = data.categories || {};
    const lastUpdate = data.last_update_time;
    const trendScore = data.trend_score;
    const site = data.site || "";
    const url = data.url || "";
    const spotifyUrl = data.spotify_url;
    const itunesId = data.itunes_id;
    const podcastGuid = data.podcast_guid;

    // Format last update date
    let lastUpdateDisplay = "";
    if (lastUpdate) {
      try {
        const date = new Date(lastUpdate);
        lastUpdateDisplay = date.toLocaleDateString("en-US", {
          year: "numeric",
          month: "long",
          day: "numeric",
        });
      } catch (e) {
        lastUpdateDisplay = lastUpdate;
      }
    }

    // Format categories as tags
    const categoryTags = Object.values(categories)
      .filter((c) => c)
      .slice(0, 5);

    modalBody.innerHTML = `
      <div class="p-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
          <!-- Podcast Artwork -->
          <div class="flex-shrink-0 mx-auto md:mx-0">
            ${image
        ? `<img src="${image}" alt="${title}" class="w-40 md:w-48 rounded-xl shadow-2xl border border-surface-700">`
        : `<div class="w-40 md:w-48 h-40 md:h-48 rounded-xl bg-surface-800 flex items-center justify-center border border-surface-700">
                    <svg class="w-16 h-16 text-surface-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"/>
                    </svg>
                  </div>`
      }
          </div>
          
          <!-- Info -->
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl md:text-3xl font-bold text-white">${title}</h2>
            
            ${author
        ? `<p class="mt-2 text-lg text-pink-400 font-medium">${author}</p>`
        : ""
      }
            
            <div class="flex flex-wrap items-center gap-3 mt-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium bg-pink-500/20 text-pink-400">
                üéôÔ∏è Podcast
              </span>
              ${episodeCount > 0
        ? `<span class="text-surface-400">${episodeCount.toLocaleString()} episodes</span>`
        : ""
      }
              ${language
        ? `<span class="text-surface-500 uppercase text-sm">${language}</span>`
        : ""
      }
            </div>
            
            ${trendScore
        ? `
              <div class="flex items-center gap-2 mt-3">
                <span class="text-surface-500 text-sm">Trend Score:</span>
                <span class="text-pink-400 font-medium">${trendScore.toFixed(1)}</span>
              </div>
            `
        : ""
      }
            
            ${lastUpdateDisplay
        ? `<p class="mt-2 text-surface-500 text-sm">Last updated: ${lastUpdateDisplay}</p>`
        : ""
      }
            
            <!-- Categories -->
            ${categoryTags.length > 0
        ? `
              <div class="flex flex-wrap gap-2 mt-4">
                ${categoryTags
          .map(
            (cat) =>
              `<span class="px-3 py-1 bg-surface-800 rounded-full text-sm text-surface-300">${cat}</span>`
          )
          .join("")}
              </div>
            `
        : ""
      }
          </div>
        </div>
        
        <!-- Description -->
        <div class="mb-8">
          <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">About</h3>
          <p class="text-surface-300 leading-relaxed">${description}</p>
        </div>
        
        <!-- Listen Links -->
        ${spotifyUrl || site || url
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">Listen</h3>
            <div class="flex flex-wrap gap-3">
              ${spotifyUrl
          ? `
                <a href="${spotifyUrl}" target="_blank" rel="noopener noreferrer"
                   class="flex items-center gap-2 px-4 py-2 bg-[#1DB954] hover:bg-[#1ed760] rounded-lg text-white font-medium transition-colors">
                  <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 0C5.4 0 0 5.4 0 12s5.4 12 12 12 12-5.4 12-12S18.66 0 12 0zm5.521 17.34c-.24.359-.66.48-1.021.24-2.82-1.74-6.36-2.101-10.561-1.141-.418.122-.779-.179-.899-.539-.12-.421.18-.78.54-.9 4.56-1.021 8.52-.6 11.64 1.32.42.18.479.659.301 1.02zm1.44-3.3c-.301.42-.841.6-1.262.3-3.239-1.98-8.159-2.58-11.939-1.38-.479.12-1.02-.12-1.14-.6-.12-.48.12-1.021.6-1.141C9.6 9.9 15 10.561 18.72 12.84c.361.181.54.78.241 1.2zm.12-3.36C15.24 8.4 8.82 8.16 5.16 9.301c-.6.179-1.2-.181-1.38-.721-.18-.601.18-1.2.72-1.381 4.26-1.26 11.28-1.02 15.721 1.621.539.3.719 1.02.419 1.56-.299.421-1.02.599-1.559.3z"/>
                  </svg>
                  Spotify
                </a>
              `
          : ""
        }
              ${site
          ? `
                <a href="${site}" target="_blank" rel="noopener noreferrer"
                   class="flex items-center gap-2 px-4 py-2 bg-surface-700 hover:bg-surface-600 rounded-lg text-white font-medium transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9"/>
                  </svg>
                  Website
                </a>
              `
          : ""
        }
              ${url
          ? `
                <a href="${url}" target="_blank" rel="noopener noreferrer"
                   class="flex items-center gap-2 px-4 py-2 bg-surface-700 hover:bg-surface-600 rounded-lg text-white font-medium transition-colors">
                  <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 5c7.18 0 13 5.82 13 13M6 11a7 7 0 017 7m-6 0a1 1 0 11-2 0 1 1 0 012 0z"/>
                  </svg>
                  RSS Feed
                </a>
              `
          : ""
        }
            </div>
          </div>
        `
        : ""
      }
        
        <!-- Technical Details -->
        <div class="pt-6 border-t border-surface-800">
          <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Details</h3>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
            <div>
              <span class="text-surface-500">Feed ID</span>
              <p class="text-surface-300 mt-1">${data.id || "N/A"}</p>
            </div>
            ${itunesId
        ? `
              <div>
                <span class="text-surface-500">iTunes ID</span>
                <p class="text-surface-300 mt-1">${itunesId}</p>
              </div>
            `
        : ""
      }
            ${podcastGuid
        ? `
              <div>
                <span class="text-surface-500">GUID</span>
                <p class="text-surface-300 font-mono text-xs mt-1 truncate" title="${podcastGuid}">${podcastGuid.substring(0, 20)}...</p>
              </div>
            `
        : ""
      }
            <div>
              <span class="text-surface-500">Source</span>
              <p class="text-surface-300 mt-1">${data.source || "PodcastIndex"}</p>
            </div>
          </div>
        </div>
        
        <!-- Raw JSON Toggle -->
        <details class="mt-6">
          <summary class="cursor-pointer text-sm text-surface-500 hover:text-surface-300 transition-colors">
            View Raw JSON
          </summary>
          <pre class="mt-3 p-4 bg-surface-950 rounded-lg overflow-x-auto text-xs text-surface-400 max-h-64 overflow-y-auto"><code>${JSON.stringify(
        data,
        null,
        2
      )}</code></pre>
        </details>
      </div>
    `;
  }

  function renderAuthorDetail(data) {
    const name = data.name || data.search_title || "Unknown Author";
    const bio = data.bio || data.full_overview || data.overview || "";
    const image = data.image || null;
    const photoUrls = data.photo_urls || {};
    const fallbackImage = photoUrls.wikidata || null;
    const birthDate = data.birth_date || "";
    const deathDate = data.death_date || "";
    const openlibraryUrl = data.openlibrary_url || "";
    const authorLinks = data.author_links || [];
    const remoteIds = data.remote_ids || {};
    const wikidataId = data.wikidata_id || remoteIds.wikidata || "";

    // Format life dates
    let lifeDates = "";
    if (birthDate) {
      lifeDates = `Born ${birthDate}`;
      if (deathDate) {
        lifeDates += ` ‚Äî Died ${deathDate}`;
      }
    }

    modalBody.innerHTML = `
      <div class="p-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
          <!-- Author Photo -->
          <div class="flex-shrink-0 mx-auto md:mx-0">
            ${image
        ? `<img src="${image}" alt="${name}" class="w-40 md:w-48 h-40 md:h-48 object-cover rounded-full shadow-2xl border-4 border-amber-500/30" data-fallback="${fallbackImage || ''}" onload="var img=this; setTimeout(function(){ if(img.naturalWidth<=1||img.naturalHeight<=1){ if(img.dataset.fallback&&!img.dataset.triedFallback){ img.dataset.triedFallback='true'; img.src=img.dataset.fallback; } else { img.style.display='none'; img.parentElement.innerHTML='<div class=\\'w-40 md:w-48 h-40 md:h-48 rounded-full bg-surface-800 flex items-center justify-center border-4 border-amber-500/30\\'><svg class=\\'w-16 h-16 text-amber-500\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\\'/></svg></div>'; }}},0);" onerror="if(this.dataset.fallback && !this.dataset.triedFallback) { this.dataset.triedFallback='true'; this.src=this.dataset.fallback; } else { this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-40 md:w-48 h-40 md:h-48 rounded-full bg-surface-800 flex items-center justify-center border-4 border-amber-500/30\\'><svg class=\\'w-16 h-16 text-amber-500\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\\'/></svg></div>'; }'">`
        : `<div class="w-40 md:w-48 h-40 md:h-48 rounded-full bg-surface-800 flex items-center justify-center border-4 border-amber-500/30">
                    <svg class="w-16 h-16 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                  </div>`
      }
          </div>
          
          <!-- Info -->
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl md:text-3xl font-bold text-white">${name}</h2>
            
            <div class="flex flex-wrap items-center gap-3 mt-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium bg-amber-500/20 text-amber-400">
                üìö Author
              </span>
              ${lifeDates
        ? `<span class="text-surface-400">${lifeDates}</span>`
        : ""
      }
            </div>
            
            ${data.wikidata_name && data.wikidata_name !== name
        ? `<p class="mt-2 text-surface-500 text-sm">Also known as: ${data.wikidata_name}</p>`
        : ""
      }
          </div>
        </div>
        
        <!-- Biography -->
        ${bio
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Biography</h3>
            <p class="text-surface-300 leading-relaxed whitespace-pre-line">${bio}</p>
          </div>
        `
        : ""
      }
        
        <!-- External Links -->
        ${authorLinks.length > 0
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-4">External Links</h3>
            <div class="flex flex-wrap gap-3">
              ${authorLinks.map(link => `
                <a href="${link.url}" target="_blank" rel="noopener noreferrer"
                   class="flex items-center gap-2 px-4 py-2 bg-surface-700 hover:bg-surface-600 rounded-lg text-white font-medium transition-colors">
                  ${link.title}
                  <svg class="w-3 h-3 text-surface-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                  </svg>
                </a>
              `).join('')}
            </div>
          </div>
        `
        : ""
      }
        
        <!-- Details -->
        <div class="pt-6 border-t border-surface-800">
          <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Details</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
            <div>
              <span class="text-surface-500">Source</span>
              <p class="text-surface-300 mt-1">${data.source || "OpenLibrary"}</p>
            </div>
            ${data.openlibrary_key
        ? `
              <div>
                <span class="text-surface-500">OpenLibrary ID</span>
                <p class="text-surface-300 mt-1 font-mono text-xs">${data.openlibrary_key.replace('/authors/', '')}</p>
              </div>
            `
        : ""
      }
            ${wikidataId
        ? `
              <div>
                <span class="text-surface-500">Wikidata ID</span>
                <p class="text-surface-300 mt-1 font-mono text-xs">${wikidataId}</p>
              </div>
            `
        : ""
      }
            ${data.work_count > 0
        ? `
              <div>
                <span class="text-surface-500">Works</span>
                <p class="text-surface-300 mt-1">${data.work_count.toLocaleString()}</p>
              </div>
            `
        : ""
      }
          </div>
        </div>
        
        <!-- Raw JSON Toggle -->
        <details class="mt-6">
          <summary class="cursor-pointer text-sm text-surface-500 hover:text-surface-300 transition-colors">
            View Raw JSON
          </summary>
          <pre class="mt-3 p-4 bg-surface-950 rounded-lg overflow-x-auto text-xs text-surface-400 max-h-64 overflow-y-auto"><code>${JSON.stringify(
        data,
        null,
        2
      )}</code></pre>
        </details>
      </div>
    `;
  }

  function renderBookDetail(data) {
    const title = data.title || data.search_title || "Unknown Book";
    const author = data.author || data.author_search || "";
    const authorNames = data.author_name || [];
    const description = data.description || data.full_overview || data.overview || "";
    const cover_i = data.cover_i;
    const coverUrl = cover_i ? `https://covers.openlibrary.org/b/id/${cover_i}-L.jpg` : "";
    const firstPublishYear = data.first_publish_year;
    const subjects = data.subjects || data.subject || [];
    const ratingsAverage = data.ratings_average;
    const ratingsCount = data.ratings_count;
    const readinglogCount = data.readinglog_count;
    const openlibraryKey = data.openlibrary_key || data.key;
    const openlibraryUrl = openlibraryKey ? `https://openlibrary.org${openlibraryKey}` : "";
    const firstSentence = data.first_sentence;
    const numberOfPages = data.number_of_pages;
    const publisher = data.publisher;
    const isbn13 = data.primary_isbn13;
    const isbn10 = data.primary_isbn10;

    // Format first sentence
    let firstSentenceText = "";
    if (firstSentence) {
      if (Array.isArray(firstSentence)) {
        firstSentenceText = firstSentence[0] || "";
      } else {
        firstSentenceText = firstSentence;
      }
    }

    modalBody.innerHTML = `
      <div class="p-6">
        <!-- Header -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
          <!-- Book Cover -->
          <div class="flex-shrink-0 mx-auto md:mx-0">
            ${coverUrl
        ? `<img src="${coverUrl}" alt="${title}" class="w-40 md:w-48 h-auto max-h-72 object-contain rounded-lg shadow-2xl border-2 border-emerald-500/30" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=\\'w-40 md:w-48 h-64 rounded-lg bg-surface-800 flex items-center justify-center border-2 border-emerald-500/30\\'><svg class=\\'w-16 h-16 text-emerald-500\\' fill=\\'none\\' stroke=\\'currentColor\\' viewBox=\\'0 0 24 24\\'><path stroke-linecap=\\'round\\' stroke-linejoin=\\'round\\' stroke-width=\\'1.5\\' d=\\'M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253\\'/></svg></div>';">`
        : `<div class="w-40 md:w-48 h-64 rounded-lg bg-surface-800 flex items-center justify-center border-2 border-emerald-500/30">
                    <svg class="w-16 h-16 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                  </div>`
      }
          </div>
          
          <!-- Info -->
          <div class="flex-1 min-w-0">
            <h2 class="text-2xl md:text-3xl font-bold text-white">${title}</h2>
            
            ${author || authorNames.length > 0
        ? `<p class="mt-2 text-lg text-emerald-400">${author || authorNames.join(", ")}</p>`
        : ""
      }
            
            <div class="flex flex-wrap items-center gap-3 mt-4">
              <span class="px-3 py-1 rounded-full text-sm font-medium bg-emerald-500/20 text-emerald-400">
                üìö Book
              </span>
              ${firstPublishYear
        ? `<span class="text-surface-400">Published ${firstPublishYear}</span>`
        : ""
      }
              ${numberOfPages
        ? `<span class="text-surface-500">${numberOfPages} pages</span>`
        : ""
      }
            </div>
            
            <!-- Ratings -->
            ${ratingsAverage || ratingsCount
        ? `
              <div class="flex items-center gap-4 mt-4">
                ${ratingsAverage
          ? `<div class="flex items-center gap-1">
                      <span class="text-yellow-400 text-lg">‚òÖ</span>
                      <span class="text-white font-semibold">${ratingsAverage.toFixed(1)}</span>
                      <span class="text-surface-500">/5</span>
                    </div>`
          : ""
        }
                ${ratingsCount
          ? `<span class="text-surface-500">${ratingsCount.toLocaleString()} ratings</span>`
          : ""
        }
                ${readinglogCount
          ? `<span class="text-surface-500">${readinglogCount.toLocaleString()} readers</span>`
          : ""
        }
              </div>
            `
        : ""
      }
            
            <!-- OpenLibrary Link -->
            ${openlibraryUrl
        ? `
              <a href="${openlibraryUrl}" target="_blank" rel="noopener noreferrer"
                 class="inline-flex items-center gap-2 mt-4 px-4 py-2 bg-emerald-600 hover:bg-emerald-500 rounded-lg text-white font-medium transition-colors">
                View on OpenLibrary
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"/>
                </svg>
              </a>
            `
        : ""
      }
          </div>
        </div>
        
        <!-- First Sentence -->
        ${firstSentenceText
        ? `
          <div class="mb-8 p-4 bg-emerald-500/10 border-l-4 border-emerald-500 rounded-r-lg">
            <p class="text-surface-300 italic">"${firstSentenceText}"</p>
            <p class="text-surface-500 text-sm mt-2">‚Äî First sentence</p>
          </div>
        `
        : ""
      }
        
        <!-- Description -->
        ${description
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Description</h3>
            <p class="text-surface-300 leading-relaxed whitespace-pre-line">${description}</p>
          </div>
        `
        : ""
      }
        
        <!-- Subjects -->
        ${subjects.length > 0
        ? `
          <div class="mb-8">
            <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Subjects</h3>
            <div class="flex flex-wrap gap-2">
              ${subjects.slice(0, 15).map(subject => `
                <span class="px-3 py-1 bg-surface-800 text-surface-300 rounded-full text-sm">${subject}</span>
              `).join('')}
              ${subjects.length > 15 ? `<span class="px-3 py-1 text-surface-500 text-sm">+${subjects.length - 15} more</span>` : ''}
            </div>
          </div>
        `
        : ""
      }
        
        <!-- Details -->
        <div class="pt-6 border-t border-surface-800">
          <h3 class="text-sm font-semibold text-surface-400 uppercase tracking-wider mb-3">Details</h3>
          <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
            <div>
              <span class="text-surface-500">Source</span>
              <p class="text-surface-300 mt-1">${data.source || "OpenLibrary"}</p>
            </div>
            ${openlibraryKey
        ? `
              <div>
                <span class="text-surface-500">OpenLibrary ID</span>
                <p class="text-surface-300 mt-1 font-mono text-xs">${openlibraryKey.replace('/works/', '')}</p>
              </div>
            `
        : ""
      }
            ${isbn13
        ? `
              <div>
                <span class="text-surface-500">ISBN-13</span>
                <p class="text-surface-300 mt-1 font-mono text-xs">${isbn13}</p>
              </div>
            `
        : ""
      }
            ${isbn10
        ? `
              <div>
                <span class="text-surface-500">ISBN-10</span>
                <p class="text-surface-300 mt-1 font-mono text-xs">${isbn10}</p>
              </div>
            `
        : ""
      }
            ${publisher
        ? `
              <div>
                <span class="text-surface-500">Publisher</span>
                <p class="text-surface-300 mt-1">${Array.isArray(publisher) ? publisher[0] : publisher}</p>
              </div>
            `
        : ""
      }
          </div>
        </div>
        
        <!-- Raw JSON Toggle -->
        <details class="mt-6">
          <summary class="cursor-pointer text-sm text-surface-500 hover:text-surface-300 transition-colors">
            View Raw JSON
          </summary>
          <pre class="mt-3 p-4 bg-surface-950 rounded-lg overflow-x-auto text-xs text-surface-400 max-h-64 overflow-y-auto"><code>${JSON.stringify(
        data,
        null,
        2
      )}</code></pre>
        </details>
      </div>
    `;
  }

  // Add click handler to results via event delegation
  resultsList.addEventListener("click", (e) => {
    const resultItem = e.target.closest("[data-media-id]");
    if (resultItem) {
      const mediaId = resultItem.dataset.mediaId;
      const sourceId = resultItem.dataset.sourceId;
      const mcType = resultItem.dataset.mcType;
      const mcSubtype = resultItem.dataset.mcSubtype;
      openModal(mediaId, sourceId, mcType, mcSubtype);
    }
  });

  // Helper function to extract YouTube video ID from URL
  function getYouTubeVideoId(url) {
    if (!url) return null;
    // Match youtube.com/watch?v=ID or youtu.be/ID
    const patterns = [
      /(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/,
      /youtube\.com\/embed\/([a-zA-Z0-9_-]{11})/,
    ];
    for (const pattern of patterns) {
      const match = url.match(pattern);
      if (match) return match[1];
    }
    return null;
  }

  // Add click handler for cast members and credits in the modal
  modalBody.addEventListener("click", (e) => {
    // Handle trailer thumbnail click - play video inline
    const trailerThumbnail = e.target.closest(".trailer-thumbnail");
    if (trailerThumbnail) {
      const container = trailerThumbnail.closest(".trailer-container");
      if (container) {
        const videoUrl = container.dataset.videoUrl;
        const videoId = getYouTubeVideoId(videoUrl);
        if (videoId) {
          const embedDiv = container.querySelector(".trailer-embed");
          if (embedDiv) {
            // Create YouTube embed iframe with autoplay
            embedDiv.innerHTML = `
              <iframe 
                src="https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0" 
                class="w-full h-full rounded-xl"
                frameborder="0" 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                allowfullscreen>
              </iframe>
            `;
            // Hide thumbnail, show embed
            trailerThumbnail.classList.add("hidden");
            embedDiv.classList.remove("hidden");
          }
        }
      }
      return;
    }

    // Handle cast member clicks (from media detail view)
    const castCard = e.target.closest(".cast-member-card");
    if (castCard) {
      const personId = castCard.dataset.personId;
      if (personId) {
        // Show loading state in the modal
        modalLoading.classList.remove("hidden");
        modalBody.classList.add("hidden");
        // Fetch person details
        fetchMediaDetail(
          `tmdb_person_${personId}`,
          personId,
          "person",
          "actor"
        );
      }
      return;
    }

    // Handle credit card clicks (from person detail view)
    const creditCard = e.target.closest(".credit-card");
    if (creditCard) {
      const tmdbId = creditCard.dataset.tmdbId;
      const mcType = creditCard.dataset.mcType;
      if (tmdbId && mcType) {
        // Show loading state in the modal
        modalLoading.classList.remove("hidden");
        modalBody.classList.add("hidden");
        // Fetch media details
        const mcId = `tmdb_${mcType}_${tmdbId}`;
        fetchMediaDetail(mcId, tmdbId, mcType, null);
      }
    }
  });
</script>
{% endblock %}