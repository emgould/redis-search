---
description: Reference documentation for Search and Autocomplete API endpoints
globs: ["**/search*.py", "**/app.py", "**/autocomplete*"]
alwaysApply: false
---

# Search API Reference

## Overview

The Redis Search service provides multiple endpoints for searching across media content. Results are sourced from two types of backends:

- **Indexed (RediSearch)**: tv, movie, person, podcast, author, book
- **Brokered (Redis-cached APIs)**: artist, album, video, news, ratings

## Endpoints

### 1. Autocomplete (JSON)

```
GET /api/autocomplete?q={query}&sources={sources}
```

**Parameters:**
| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `q` | string | Yes | Search query (min 2 characters). May include source keywords (e.g., "movie", "podcast") when sources not specified; see Query Source Hints. |
| `sources` | string | No | Comma-separated list of sources to search |
| `raw` | bool | No | If true, treat `q` as raw RediSearch syntax (disables source hint parsing) |

**Valid Sources:** `tv`, `movie`, `person`, `podcast`, `author`, `book`, `news`, `video`, `ratings`, `artist`, `album`

**Example:**
```
/api/autocomplete?q=breaking+bad
/api/autocomplete?q=beatles&sources=artist,album
/api/autocomplete?q=matrix&sources=tv,movie
```

**Response:** JSON object with results grouped by source type. When a source hint was applied, includes `source_hint` (array of source names).

---

### 2. Autocomplete (Streaming/SSE)

```
GET /api/autocomplete/stream?q={query}&sources={sources}
```

Same parameters as above, but returns **Server-Sent Events (SSE)** where results stream as they become available. Faster sources (indexed) return first, slower sources (API-backed) return later.

**Event Types:**
- `result` - Contains results from one source: `{source, results, latency_ms}`
- `exact_match` - Emitted when a source yields an exact match (e.g., query "the godfather" matches movie "The Godfather"). Data is a single MCBaseItem. May fire multiple times per stream.
- `done` - Indicates all sources have completed. Payload may include `source_hint` when a source hint was applied.

**Example JavaScript:**
```javascript
const es = new EventSource('/api/autocomplete/stream?q=breaking+bad');

es.addEventListener('result', (e) => {
  const data = JSON.parse(e.data);
  console.log(`${data.source}: ${data.results.length} results (${data.latency_ms}ms)`);
});

es.addEventListener('exact_match', (e) => {
  const item = JSON.parse(e.data);
  // Surface immediately - likely what user is looking for
});

es.addEventListener('done', () => es.close());
```

---

### 3. Full Search

```
GET /api/search?q={query}&sources={sources}&limit={limit}
```

**Parameters:**
| Parameter | Type | Required | Default | Description |
|-----------|------|----------|---------|-------------|
| `q` | string | No* | - | Search query (min 2 characters) |
| `sources` | string | No | all | Comma-separated list of sources |
| `limit` | int | No | 10 | Max results per source (1-50) |
| `genre_ids` | string | No | - | Comma-separated TMDB genre IDs (e.g., 35,18) |
| `genre_match` | string | No | any | Genre matching: "any" (OR) or "all" (AND) |
| `cast_ids` | string | No | - | Comma-separated TMDB person IDs (e.g., 287,1461) |
| `cast_match` | string | No | any | Cast matching: "any" (OR) or "all" (AND) |
| `year_min` | int | No | - | Minimum release year |
| `year_max` | int | No | - | Maximum release year |
| `rating_min` | float | No | - | Minimum rating (0-10) |
| `rating_max` | float | No | - | Maximum rating (0-10) |
| `mc_type` | string | No | - | Filter by type: movie, tv |
| `ratings_sort` | string | No | popularity | Sort order for ratings results when ratings source is requested with tv/movie. Options: "popularity" (default), "audience_score", "critics_score". Sorts in descending order (highest first). |
| `raw` | bool | No | false | If true, treat `q` as raw RediSearch syntax (disables source hint parsing) |

*`q` is required for brokered sources (artist, album, video, news). When `sources` is not specified, `q` may include source keywords (e.g., "godfather movie"); see Query Source Hints. The `ratings` source is special: when requested together with `tv` or `movie`, it can be enriched from indexed results even without a query parameter. Indexed sources (tv, movie, person, podcast, author, book) support field-only filtering without a text query.

**Field Filters:**
- Filters only apply to indexed sources (tv, movie)
- When using filters without `q`, sources default to indexed sources only
- Multiple genre IDs: use `genre_match=any` for OR (default) or `genre_match=all` for AND
- Numeric ranges are inclusive

**Ratings Enrichment:**
- When `ratings` is requested with `tv` or `movie` sources, ratings are enriched in two ways:
  - **With query**: Direct RottenTomatoes search using the query
  - **Filter-only (no query)**: Ratings are enriched from indexed tv/movie results by searching RottenTomatoes for each title
- Ratings results are sorted according to `ratings_sort` parameter (default: popularity)

**Example:**
```
/api/search?q=beatles
/api/search?q=beatles&sources=artist,album&limit=20
/api/search?q=matrix&sources=tv,movie,ratings

# Field-only filtering (no text query)
/api/search?sources=movie&genre_ids=878&year_min=2020
/api/search?sources=tv&rating_min=8
/api/search?sources=movie&year_min=2000&year_max=2010&rating_min=7

# Multiple genres with OR/AND logic
/api/search?sources=movie&genre_ids=35,18                    # Comedy OR Drama
/api/search?sources=movie&genre_ids=35,18&genre_match=all    # Comedy AND Drama

# Filter by cast (TMDB person IDs)
/api/search?sources=movie&cast_ids=287                       # Movies with Brad Pitt
/api/search?sources=movie&cast_ids=287,1461&cast_match=all   # Movies with Brad Pitt AND George Clooney

# Combined text search + filters
/api/search?q=action&sources=movie&year_min=2020&rating_min=7

# Sort ratings by audience score (when ratings + tv/movie are requested)
/api/search?q=matrix&sources=movie,ratings&ratings_sort=audience_score

# Sort ratings by critics score
/api/search?q=breaking&sources=tv,ratings&ratings_sort=critics_score

# Filter-only: Ratings enriched from indexed results (no query needed)
/api/search?sources=movie,ratings&genre_ids=878&ratings_sort=audience_score
/api/search?sources=movie,ratings&year_min=2020&rating_min=7&ratings_sort=critics_score
```

---

### 4. Media Details

```
POST /api/details?mc_id={id}&source_id={id}&mc_type={type}
```

Get detailed information for a specific media item, including watch providers, full cast, trailers, and keywords.

---

### 5. Cast Names Search

```
GET /api/cast-names?query={title}&media_type={type}
```

Search for a movie/TV show and return cast names split into first/last parts. Useful for trivia and game applications.

---

## Query Source Hints

When `sources` is not specified and `raw=false`, the query can include source keywords as prefix or suffix to restrict the search. The keyword is stripped from the query and the corresponding source filter is applied.

**Keywords:**

| Keyword | Maps to source |
|---------|----------------|
| podcast | podcast |
| movie | movie |
| video | video |
| book | book |
| actor, actress | person |
| author | author |
| artist | artist |
| album | album |
| tv show, tv series, tvshow, tvseries | tv |

**Rules:**
- Suffix wins over prefix (rightmost match)
- Stripped query must be at least 3 characters; otherwise no hint is applied
- Case-insensitive matching
- Skipped when `raw=true` or when `sources` is explicitly provided

**Examples:**
| Query | Effective query | Source filter |
|-------|-----------------|---------------|
| the godfather movie | the godfather | movie |
| podcast joe rogan | joe rogan | podcast |
| breaking bad tv show | breaking bad | tv |
| something movie podcast | something movie | podcast |

**Response field:** When a hint is applied, responses include `source_hint` (array of source names). JSON responses add it as a top-level key; streaming `done` events include it in the payload.

---

## Query Behavior

### Prefix Matching (Autocomplete)
The autocomplete uses **prefix matching** on the last word:

| Query | Behavior |
|-------|----------|
| `break` | Matches titles starting with "break*" |
| `breaking b` | Matches titles containing "breaking" AND starting with "b*" |
| `the matrix` | "the" is a stopword, matches "matrix*" |

### Stopwords
These common words are filtered from queries:
`the`, `a`, `an`, `and`, `or`, `but`, `in`, `on`, `at`, `to`, `for`, `of`, `is`, `it`

### Minimum Query Length
Text search (`q` parameter) requires at least **2 characters**. However, the `/api/search` endpoint supports field-only filtering without a text query for indexed sources.

---

## Indexed Fields (RediSearch)

The `idx:media` index supports filtering and sorting on these fields:

| Field | Type | Description |
|-------|------|-------------|
| `search_title` | TEXT | Primary search field (weighted 5x) |
| `mc_type` | TAG | Content type: movie, tv |
| `mc_subtype` | TAG | Subtype (for persons: actor, director, etc.) |
| `source` | TAG | Data source: tmdb |
| `genre_ids` | TAG | TMDB genre IDs as strings |
| `genres` | TAG | Genre names (normalized: science_fiction) |
| `cast_ids` | TAG | TMDB person IDs as strings |
| `cast_names` | TAG | Cast member names (normalized: tom_hanks) |
| `director_id` | TAG | Director's TMDB person ID |
| `director_name` | TAG | Director name (normalized: christopher_nolan) |
| `keywords` | TAG | Content keywords with IPTC expansion (normalized) |
| `origin_country` | TAG | Origin country codes (normalized: us, gb) |
| `popularity` | NUMERIC | Sortable popularity score |
| `rating` | NUMERIC | Sortable rating (0-10) |
| `year` | NUMERIC | Release/first air year |

### Autocomplete Union Search

Autocomplete queries search across multiple fields using OR (union):
- `search_title` - Title/name (TEXT with prefix matching)
- `cast_names` - Actor/actress names (TAG)
- `director_name` - Director name (TAG)
- `keywords` - Content keywords (TAG)
- `genres` - Genre names (TAG)

Example: Searching "spielberg" will match movies directed by Spielberg via the `director_name` field.

---

## Common TMDB Genre IDs

| ID | Genre | ID | Genre |
|----|-------|----|-------|
| 28 | Action | 18 | Drama |
| 12 | Adventure | 10751 | Family |
| 16 | Animation | 14 | Fantasy |
| 35 | Comedy | 27 | Horror |
| 80 | Crime | 10402 | Music |
| 99 | Documentary | 9648 | Mystery |
| 10749 | Romance | 878 | Science Fiction |
| 53 | Thriller | 10752 | War |
| 37 | Western | 10770 | TV Movie |

---

## Response Format

### Non-Stream (JSON) Response

Top-level keys include per-source arrays (`tv`, `movie`, `person`, etc.), optionally `exact_match`, and optionally `source_hint`:

- **`exact_match`** - `ExactMatchItem | null`. Present when the query exactly matches a known entity (e.g., "the godfather" → movie "The Godfather"). Single best match by source priority (movie > tv > person > podcast > book > author). Omitted or `null` when no exact match.
- **`source_hint`** - `string[]`. Present when a source hint was parsed from the query (e.g., "godfather movie" → sources restricted to movie). Omitted when no hint was applied.

### Result Item Format

All search results follow the **MCBaseItem** contract:

```json
{
  "mc_id": "tmdb_tv_1396",
  "mc_type": "tv",
  "mc_subtype": null,
  "source": "tmdb",
  "source_id": "1396",
  "search_title": "Breaking Bad",
  "year": 2008,
  "popularity": 156.789,
  "rating": 8.9,
  "image": "https://image.tmdb.org/t/p/w185/...",
  "cast": ["Bryan Cranston", "Aaron Paul", ...],
  "genres": ["Drama", "Crime"],
  "overview": "A high school chemistry teacher diagnosed with..."
}
```

### Exact Match Cast Shape

The `exact_match` object still follows item contract fields, but its cast payload is normalized to ID-aware objects for follow-on person lookups:

```json
{
  "exact_match": {
    "mc_id": "tmdb_movie_238",
    "mc_type": "movie",
    "source": "tmdb",
    "source_id": "238",
    "search_title": "The Godfather",
    "year": 1972,
    "cast": [
      { "name": "Marlon Brando", "id": "3084" },
      { "name": "Al Pacino", "id": "1158" }
    ]
  }
}
```

- `cast` on non-exact-match list items remains name-only arrays in index payloads (`["Bryan Cranston", ...]`).
- `exact_match.cast` uses objects: `[{ "name": "Bryan Cranston", "id": "1234" }, ...]`.

---

## Public URLs

- **Dev:** `https://redis-search-api-dev-wabm4u2pza-uc.a.run.app`
- **Local:** `http://localhost:9001`
