---
description: Response shapes for Search and Autocomplete with exact_match feature
globs: ["**/search*.py", "**/app.py", "**/autocomplete*"]
alwaysApply: false
---

# Exact Match Response Shapes

## Overview

The exact match feature adds a new `exact_match` property to search and autocomplete responses. When the user's query exactly matches a known entity (e.g., "the godfather" → movie "The Godfather"), that match is surfaced in a dedicated field.

---

## Non-Stream Responses (JSON)

**Endpoints:** `/api/search`, `/api/autocomplete`

### Before (current)

```json
{
  "tv": [...],
  "movie": [...],
  "person": [...],
  "podcast": [...],
  "author": [...],
  "book": [...],
  "news": [...],
  "video": [...],
  "ratings": [...],
  "artist": [...],
  "album": [...]
}
```

### After (evolved)

```json
{
  "exact_match": {
    "mc_id": "tmdb_238",
    "mc_type": "movie",
    "source": "tmdb",
    "source_id": "238",
    "search_title": "The Godfather",
    "year": 1972,
    "popularity": 85.2,
    "image": "https://...",
    "overview": "...",
    "cast": [
      { "name": "Marlon Brando", "id": "3084" },
      { "name": "Al Pacino", "id": "1158" },
      { "name": "James Caan", "id": "4239" }
    ]
  },
  "tv": [...],
  "movie": [...],
  "person": [...],
  "podcast": [...],
  "author": [...],
  "book": [...],
  "news": [...],
  "video": [...],
  "ratings": [...],
  "artist": [...],
  "album": [...]
}
```

**`exact_match` field:**
- **Type:** `ExactMatchItem | null`
- **When present:** At least one exact match found; contains the single best match by source priority (movie > tv > person > podcast > book > author)
- **When absent:** Omit key, or use `"exact_match": null` for consistent typing (recommend always include, use `null` when none)
- **Cast shape:** For `exact_match`, `cast` is now `Array<{ name: string, id: string | null }>` (name + TMDB ID).

---

## Streaming Responses (SSE)

**Endpoints:** `/api/search/stream`, `/api/autocomplete/stream`

### Event Types

| Event      | When                         | Data shape                                                    |
|-----------|-------------------------------|--------------------------------------------------------------|
| `result`  | Each source completes         | `{ source: string, results: MCBaseItem[], latency_ms: number }` |
| `exact_match` | **NEW** – when a source yields an exact match | `ExactMatchItem` (single item)                                  |
| `done`    | All sources complete          | `{}`                                                         |

### Event sequence example

```
event: result
data: {"source":"movie","results":[...],"latency_ms":12}

event: exact_match
data: {"mc_id":"tmdb_movie_238","mc_type":"movie","search_title":"The Godfather","cast":[{"name":"Marlon Brando","id":"3084"},...]}

event: result
data: {"source":"tv","results":[...],"latency_ms":15}

event: done
data: {}
```

**`exact_match` event behavior:**
- Emitted **as soon as** a source completes and yields at least one exact match
- May fire **multiple times** per stream (e.g., movie exact match, then person exact match)
- Client handles each event; no aggregation needed
- `exact_match` events can appear between `result` events (typically right after the `result` that contained the match)

---

## TypeScript Types (Mobile / Clients)

All types are now defined in `src/contracts/*.ts` with a barrel export from `src/contracts/index.ts`.

```typescript
import type {
  SearchResponse,
  ExactMatchItem,
  ExactMatchCastEntry,
  StreamResultEvent,
  StreamExactMatchEvent,
  StreamDoneEvent,
} from "@/contracts";
```

### Stream event handlers

```typescript
import type { StreamResultEvent, ExactMatchItem, StreamDoneEvent } from "@/contracts";

es.addEventListener("result", (e) => {
  const data: StreamResultEvent = JSON.parse(e.data);
  // data.source, data.results, data.latency_ms
});

es.addEventListener("exact_match", (e) => {
  const item: ExactMatchItem = JSON.parse(e.data);
  // Surface immediately - likely what user is looking for
});

es.addEventListener("done", (e) => {
  const data: StreamDoneEvent = JSON.parse(e.data);
  // data.source_hint may be present
  es.close();
});
```

---

## Backwards Compatibility

- **Non-stream:** Adding `exact_match` is additive; existing clients can ignore it
- **Stream:** New event type `exact_match`; clients that only listen for `result` and `done` are unchanged

## Person autocomplete matching behavior

- Person index filtering now uses a dedicated matcher for query behavior.
- Query construction and filtering for people are intentionally person-specific:
  - Multi-word person queries now require each token to match separately so names with middle words still match (`megan therese rippey`).
  - Stopword-leading phrases such as `"the rip"` still avoid broad prefix behavior.
- Other index matchers (`is_autocomplete_match`) are unchanged for non-person uses.
